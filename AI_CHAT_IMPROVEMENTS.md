# Улучшения чата с ИИ на основе практик Vercel AI SDK

## Анализ текущей реализации

### Что уже реализовано:
1. ✅ Базовый стриминг сообщений через SSE
2. ✅ Визуализация шагов выполнения агентов
3. ✅ Отображение рассуждений (reasoning)
4. ✅ План одобрения перед выполнением
5. ✅ Статусы выполнения (pending, running, completed, error)

### Что можно улучшить:

## 1. Визуализация цепочки действий (Enhanced Agent Steps)

### Текущие проблемы:
- Статичное отображение шагов без возможности раскрыть детали
- Рассуждения отображаются всегда, даже если они длинные
- Нет визуализации вызовов инструментов (tool calls)
- Нет отображения времени выполнения
- Нет структурированного отображения входных/выходных данных

### Улучшения (на основе Vercel AI SDK):
1. **Коллапсируемые секции** - возможность свернуть/развернуть детали каждого шага
2. **Визуализация tool calls** - отдельные блоки для каждого вызова инструмента с входными/выходными данными
3. **Временные метки** - отображение времени начала и длительности выполнения
4. **Структурированные данные** - красивое форматирование JSON для входных/выходных данных
5. **Анимации** - плавные переходы при изменении статусов
6. **Иконки для типов действий** - визуальное различие между рассуждениями, вызовами инструментов, результатами

## 2. Стриминг рассуждений в реальном времени

### Текущая реализация:
- Рассуждения приходят только после завершения шага

### Улучшение:
- Потоковая передача рассуждений по мере их генерации
- Отображение "печатающегося" текста для рассуждений
- Индикатор того, что агент "думает"

## 3. Интерактивность

### Добавить:
- Возможность остановить выполнение на любом этапе
- Возможность перезапустить конкретный шаг
- Копирование результатов/ошибок
- Экспорт цепочки действий в JSON/Markdown

## 4. Визуализация плана

### Текущая реализация:
- План отображается в карточке одобрения

### Улучшение:
- Интерактивная визуализация плана как графа/дерева
- Возможность видеть зависимости между шагами
- Прогресс-бар для общего выполнения плана

## 5. Обработка ошибок

### Улучшения:
- Более детальная информация об ошибках
- Стеки вызовов для отладки
- Предложения по исправлению ошибок
- Возможность повторить шаг с ошибкой

## 6. Производительность

### Оптимизации:
- Виртуализация списка шагов для больших планов
- Ленивая загрузка деталей шагов
- Мемоизация компонентов

## Примеры использования улучшенного компонента

```typescript
// Базовое использование
<EnhancedAgentStepsView 
  steps={agentSteps} 
  isStreaming={isLoading}
/>

// С отключенными рассуждениями
<EnhancedAgentStepsView 
  steps={agentSteps} 
  isStreaming={isLoading}
  showReasoning={false}
/>

// Без возможности сворачивания
<EnhancedAgentStepsView 
  steps={agentSteps} 
  isStreaming={isLoading}
  collapsible={false}
/>
```

## Интеграция с бэкендом

### Требуемые изменения в API:

1. **Расширенная структура шага:**
```python
{
  "step_id": "step_123",
  "agent_name": "Timeline Agent",
  "description": "Извлечение временной шкалы",
  "status": "running",
  "reasoning": "Анализирую документ...",
  "tool_calls": [
    {
      "name": "extract_timeline",
      "input": {"document_id": "doc_123"},
      "output": {"events": [...]}
    }
  ],
  "duration": 1250,  # в миллисекундах
  "timestamp": "2025-12-30T17:10:00Z"
}
```

2. **Потоковая передача рассуждений:**
```python
# Вместо отправки полного reasoning после завершения
# Отправлять части рассуждений по мере генерации
{
  "type": "reasoning_chunk",
  "step_id": "step_123",
  "chunk": "Анализирую первую часть документа..."
}
```

## Следующие шаги

1. ✅ Создан улучшенный компонент `EnhancedAgentStepsView`
2. ⏳ Интегрировать в `AssistantUIChat`
3. ⏳ Обновить бэкенд для поддержки расширенной структуры шагов
4. ⏳ Добавить потоковую передачу рассуждений
5. ⏳ Добавить интерактивные функции (остановка, перезапуск)
6. ⏳ Оптимизировать производительность

