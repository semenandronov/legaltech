# Решение проблемы PERMISSION_DENIED для Yandex Cloud Files API

## Проблема

Ошибка: `Permission CREATE denied to folder b1g4samml2s1n1509ptp. You do not have permissions. You need the ai.assistants.editor, editor, or admin role for the folder in question.`

## Пошаговая диагностика

### Шаг 1: Определите, какой API ключ используется

1. Перейдите в Render Dashboard → ваш сервис → Environment
2. Найдите переменную `YANDEX_API_KEY`
3. **ВАЖНО:** Запомните первые несколько символов ключа (например, `AQVN...`)

### Шаг 2: Найдите сервисный аккаунт, которому принадлежит API ключ

**Вариант А: Через Yandex Cloud Console**

1. Перейдите: https://console.cloud.yandex.ru/iam/service-accounts
2. Откройте каждый сервисный аккаунт в вашем каталоге `b1g4samml2s1n1509ptp`
3. Перейдите на вкладку **"API ключи"** (API Keys)
4. Найдите ключ, который начинается с тех же символов, что и `YANDEX_API_KEY` в Render
5. Запомните **ID сервисного аккаунта** (например, `aje48d6mf9lbcukf`)

**Вариант Б: Если у вас много сервисных аккаунтов**

Если у вас несколько сервисных аккаунтов, создайте новый ключ для аккаунта "layer":

1. Перейдите: https://console.cloud.yandex.ru/iam/service-accounts
2. Найдите сервисный аккаунт **"layer"** (ID: `aje48d6mf9lbcukf`)
3. Откройте его
4. Перейдите на вкладку **"API ключи"**
5. Нажмите **"Создать API ключ"**
6. Скопируйте новый ключ
7. Обновите `YANDEX_API_KEY` в Render с новым ключом

### Шаг 3: Убедитесь, что нужная роль назначена правильному аккаунту

1. Перейдите на страницу прав доступа каталога:
   - https://console.cloud.yandex.ru/folders/b1g4samml2s1n1509ptp/access

2. Найдите сервисный аккаунт, которому принадлежит API ключ (определен на Шаге 2)

3. **Проверьте роли:**
   - ✅ Должна быть: `ai.assistants.editor` (ОБЯЗАТЕЛЬНО для Files API!)
   - ✅ Может быть: `ai.languageModels.user` (для YandexGPT)
   - ❌ НЕДОСТАТОЧНО: `ai.assistants.auditor` (только просмотр, не создание)

4. **Если роли `ai.assistants.editor` нет:**
   - Нажмите **"Настроить доступ"**
   - Выберите сервисный аккаунт
   - Нажмите **"Изменить роли"** или **"Добавить роль"**
   - Найдите и выберите: **`ai.assistants.editor`**
   - Нажмите **"Сохранить"**

### Шаг 4: Подождите обновления кэша разрешений

⚠️ **ВАЖНО:** После добавления роли Yandex Cloud может обновлять кэш разрешений до **5-10 минут**.

1. Подождите 5-10 минут после добавления роли
2. Попробуйте снова загрузить документ
3. Если ошибка все еще возникает, перейдите к Шагу 5

### Шаг 5: Перезапустите сервис в Render (если нужно)

Иногда может помочь перезапуск сервиса:

1. Render Dashboard → ваш сервис
2. Нажмите **"Manual Deploy"** → **"Clear build cache & deploy"**
3. Дождитесь завершения деплоя
4. Попробуйте снова загрузить документ

### Шаг 6: Проверьте через Yandex Cloud CLI (опционально)

Если у вас установлен Yandex Cloud CLI, можете проверить роли программно:

```bash
# Проверьте роли для каталога
yc resource-manager folder list-access-bindings b1g4samml2s1n1509ptp

# Добавьте роль для сервисного аккаунта (если нужно)
yc resource-manager folder add-access-binding b1g4samml2s1n1509ptp \
  --role ai.assistants.editor \
  --subject serviceAccount:aje48d6mf9lbcukf
```

**Примечание:** Замените `aje48d6mf9lbcukf` на ID вашего сервисного аккаунта из Шага 2.

## Частые ошибки

### Ошибка 1: Роль назначена другому аккаунту

**Проблема:** Роль `ai.assistants.editor` назначена сервисному аккаунту "layer", но API ключ принадлежит другому аккаунту.

**Решение:** 
- Либо создайте новый API ключ для аккаунта "layer" (см. Шаг 2, Вариант Б)
- Либо назначьте роль `ai.assistants.editor` аккаунту, которому принадлежит текущий API ключ

### Ошибка 2: Роль `editor` вместо `ai.assistants.editor`

**Проблема:** У аккаунта есть роль `editor`, но Files API требует именно `ai.assistants.editor`.

**Решение:** Добавьте специфическую роль `ai.assistants.editor` (см. Шаг 3)

### Ошибка 3: Кэш разрешений еще не обновился

**Проблема:** Роль добавлена, но ошибка все еще возникает.

**Решение:** Подождите 5-10 минут (см. Шаг 4) и попробуйте снова

## Проверка успешного исправления

После выполнения всех шагов, в логах должно быть:

```
✅ Successfully uploaded file document.pdf via SDK
✅ Created search index {index_id} for case {case_id} with {N} files
```

Вместо ошибки `PERMISSION_DENIED`.

## Связанные документы

- `YANDEX_INTEGRATION_FAQ.md` - Общие вопросы по интеграции
- `CREATE_API_KEY_STEP_BY_STEP.md` - Инструкция по созданию API ключа

