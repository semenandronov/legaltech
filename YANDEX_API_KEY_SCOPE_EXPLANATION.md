# Область действия API ключа в Yandex Cloud

## ⚠️ Важное понимание

**API ключ в Yandex Cloud НЕ имеет собственной "области действия" или списка разрешений.**

Вместо этого, API ключ **наследует все права сервисного аккаунта**, которому он принадлежит.

## Как это работает

```
┌─────────────────────────────────┐
│   Сервисный аккаунт (layer)     │
│   Роли:                          │
│   - ai.assistants.editor         │
│   - ai.languageModels.user       │
│   - editor                       │
└──────────────┬──────────────────┘
               │
               │ Наследует права
               │
┌──────────────▼──────────────────┐
│   API ключ                      │
│   (YANDEX_API_KEY)              │
│                                 │
│   Может выполнять ВСЕ операции, │
│   доступные сервисному аккаунту │
└─────────────────────────────────┘
```

## Где настраиваются права

**Права НЕ настраиваются для API ключа напрямую.**

Права настраиваются для **сервисного аккаунта** через IAM роли:

### 1. Откройте страницу прав доступа каталога

https://console.cloud.yandex.ru/folders/b1g4samml2s1n1509ptp/access

### 2. Найдите сервисный аккаунт

- Откройте сервисный аккаунт, которому принадлежит ваш API ключ
- Проверьте его роли в столбце "Роли"

### 3. Добавьте нужные роли

Для работы с Files API и Vector Store нужна роль:
- **`ai.assistants.editor`** ✅ (ОБЯЗАТЕЛЬНО для загрузки файлов)

Дополнительно могут понадобиться:
- **`ai.languageModels.user`** - для YandexGPT и Embeddings
- **`editor`** или **`admin`** - широкие права (но лучше использовать специфичные роли)

### 4. Роли применяются ко всем API ключам этого аккаунта

Когда вы добавляете роль сервисному аккаунту, **все** API ключи этого аккаунта автоматически получают эти права.

## Что означают роли

### `ai.assistants.editor`
- ✅ Создание и редактирование ассистентов
- ✅ Загрузка файлов в Vector Store (`files.upload()`)
- ✅ Создание индексов (`search_indexes.create_deferred()`)
- ✅ Управление файлами и индексами

### `ai.assistants.auditor` (НЕДОСТАТОЧНО!)
- ✅ Только просмотр (read-only)
- ❌ НЕ может создавать или загружать файлы
- ❌ НЕ может создавать индексы

### `ai.languageModels.user`
- ✅ Использование YandexGPT
- ✅ Генерация текста
- ✅ Использование Embeddings

### `editor`
- ✅ Широкие права на редактирование ресурсов
- ⚠️ Но для Files API рекомендуется использовать `ai.assistants.editor`

## Список операций на скриншоте (`yc.*`)

Список операций типа `yc.ai.*`, `yc.monitoring.*` и т.д., который вы видите в интерфейсе, показывает:

1. **Доступные API методы** в Yandex Cloud SDK
2. **Возможные разрешения** для различных сервисов
3. **Операции**, которые можно выполнять через SDK или REST API

**НО:** Это не то, что вы настраиваете для API ключа. Это просто список доступных операций в системе.

**Реальные права определяются IAM ролями**, назначенными сервисному аккаунту.

## Проверка прав API ключа

API ключ имеет те же права, что и сервисный аккаунт. Чтобы проверить права:

1. Определите, какому сервисному аккаунту принадлежит API ключ:
   - Yandex Cloud Console → IAM → Service Accounts
   - Найдите сервисный аккаунт с вашим API ключом

2. Проверьте роли этого аккаунта:
   - Folders → `b1g4samml2s1n1509ptp` → Access management
   - Найдите сервисный аккаунт
   - Посмотрите столбец "Роли"

3. Если нужной роли нет - добавьте её (см. выше)

## Решение проблемы PERMISSION_DENIED

Если вы получаете ошибку `Permission CREATE denied`, это значит:

1. ✅ API ключ создан правильно (тип "API ключ")
2. ❌ У сервисного аккаунта нет роли `ai.assistants.editor`

**Решение:**
- Добавьте роль `ai.assistants.editor` сервисному аккаунту в настройках каталога
- Подождите 5-10 минут (кэш разрешений)
- Повторите операцию

## См. также

- `YANDEX_PERMISSIONS_TROUBLESHOOTING.md` - Пошаговая диагностика проблем с правами
- `YANDEX_INTEGRATION_FAQ.md` - Общие вопросы по интеграции

