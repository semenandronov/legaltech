# Переменные окружения для Render

Этот документ описывает все переменные окружения, необходимые для деплоя на Render.

## Обязательные переменные (sync: false)

Эти переменные должны быть установлены вручную в панели Render, так как они содержат секретные данные:

### DATABASE_URL
- **Описание:** URL подключения к PostgreSQL базе данных
- **Формат:** `postgresql://user:password@host:port/database`
- **Пример:** `postgresql://user:pass@dpg-xxxxx-a.oregon-postgres.render.com/legal_ai_vault`
- **Где получить:** Создать PostgreSQL базу данных в Render и скопировать Internal Database URL

### OPENROUTER_API_KEY
- **Описание:** API ключ для OpenRouter (для работы с LLM)
- **Формат:** `sk-or-xxxxxxxxxxxxxxxx`
- **Где получить:** Зарегистрироваться на [openrouter.ai](https://openrouter.ai) и создать API ключ

### JWT_SECRET_KEY
- **Описание:** Секретный ключ для подписи JWT токенов
- **Требования:** Минимум 32 символа, случайная строка
- **Как сгенерировать:** 
  ```python
  import secrets
  print(secrets.token_urlsafe(32))
  ```
- **Важно:** Используйте уникальный ключ для production!

## Опциональные переменные (установлены по умолчанию в render.yaml)

Эти переменные имеют значения по умолчанию, но могут быть переопределены:

### OPENROUTER_MODEL
- **Значение по умолчанию:** `openrouter/auto`
- **Описание:** Модель LLM для использования
- **Альтернативы:** `openai/gpt-4`, `anthropic/claude-3-opus`, и т.д.

### OPENROUTER_BASE_URL
- **Значение по умолчанию:** `https://openrouter.ai/api/v1`
- **Описание:** Базовый URL для OpenRouter API

### JWT_ALGORITHM
- **Значение по умолчанию:** `HS256`
- **Описание:** Алгоритм для подписи JWT токенов

### ACCESS_TOKEN_EXPIRE_MINUTES
- **Значение по умолчанию:** `1440` (24 часа)
- **Описание:** Время жизни JWT токена в минутах

### CORS_ORIGINS
- **Значение по умолчанию:** `*` (разрешены все источники)
- **Описание:** Разрешенные источники для CORS
- **Для production:** Укажите конкретные домены, например: `https://yourdomain.com,https://www.yourdomain.com`

### AGENT_ENABLED
- **Значение по умолчанию:** `true`
- **Описание:** Включить/выключить мультиагентную систему LangChain
- **Возможные значения:** `true`, `false`

### AGENT_MAX_PARALLEL
- **Значение по умолчанию:** `3`
- **Описание:** Максимальное количество параллельных агентов
- **Рекомендация:** 3-5 для оптимальной производительности

### AGENT_TIMEOUT
- **Значение по умолчанию:** `300` (5 минут)
- **Описание:** Таймаут для каждого агента в секундах
- **Рекомендация:** 300-600 секунд для больших дел

### AGENT_RETRY_COUNT
- **Значение по умолчанию:** `2`
- **Описание:** Количество повторных попыток при ошибке агента

### LangSmith (Опционально, для мониторинга)

#### LANGSMITH_API_KEY
- **Описание:** API ключ для LangSmith (опционально)
- **Формат:** Строка с API ключом
- **Где получить:** Зарегистрироваться на [langsmith.com](https://langsmith.com) и создать API ключ
- **Важно:** Не обязателен для работы системы, только для мониторинга и отладки

#### LANGSMITH_PROJECT
- **Значение по умолчанию:** `legal-ai-vault`
- **Описание:** Название проекта в LangSmith для группировки трассировок
- **Можно изменить:** Для разделения окружений (dev, staging, production)

#### LANGCHAIN_TRACING_V2
- **Значение по умолчанию:** `false`
- **Описание:** Включить/выключить трейсинг LangSmith
- **Возможные значения:** `true`, `false`
- **Важно:** Установите `true` только если `LANGSMITH_API_KEY` установлен

#### LANGCHAIN_ENDPOINT
- **Значение по умолчанию:** `https://api.smith.langchain.com`
- **Описание:** Endpoint для отправки трассировок LangSmith
- **Обычно не требуется изменять**

**Преимущества LangSmith:**
- Визуализация выполнения графа агентов
- Трассировка состояний и переходов
- Метрики производительности
- Отладка проблемных выполнений
- A/B тестирование промптов

### VECTOR_DB_DIR
- **Значение по умолчанию:** `/tmp/vector_db`
- **Описание:** Директория для хранения векторных баз данных ChromaDB
- **Важно:** На Render используйте `/tmp`, так как файловая система эфемерная
- **Примечание:** Данные будут теряться при перезапуске. Для постоянного хранения рассмотрите использование внешнего хранилища.

## Настройка в Render

### Способ 1: Через render.yaml (рекомендуется)

Переменные с `value` уже установлены в `render.yaml`. Для переменных с `sync: false` нужно установить значения в панели Render.

### Способ 2: Через панель Render

1. Перейдите в ваш сервис на Render
2. Откройте раздел "Environment"
3. Добавьте переменные:
   - `DATABASE_URL` - Internal Database URL из вашей PostgreSQL базы
   - `OPENROUTER_API_KEY` - ваш API ключ
   - `JWT_SECRET_KEY` - сгенерированный секретный ключ

### Способ 3: Через Render CLI

```bash
render env:set DATABASE_URL="postgresql://..."
render env:set OPENROUTER_API_KEY="sk-or-..."
render env:set JWT_SECRET_KEY="your-secret-key-here"
```

## Проверка переменных

После деплоя проверьте, что все переменные установлены:

```bash
# В логах Render должно быть видно предупреждения о недостающих переменных
# Или проверьте через API health endpoint
curl https://your-app.onrender.com/api/health
```

## Безопасность

⚠️ **ВАЖНО:**
- Никогда не коммитьте секретные ключи в git
- Используйте `sync: false` для всех секретных переменных
- Генерируйте уникальные `JWT_SECRET_KEY` для каждого окружения
- Регулярно ротируйте API ключи
- Используйте конкретные `CORS_ORIGINS` в production вместо `*`

## Troubleshooting

### Проблема: Агенты не работают
- Проверьте `AGENT_ENABLED=true`
- Проверьте `OPENROUTER_API_KEY` установлен и валиден
- Проверьте логи на наличие ошибок инициализации
- Если используется PostgreSQL checkpointer, убедитесь что `DATABASE_URL` правильный

### Проблема: LangSmith не работает
- Проверьте `LANGSMITH_API_KEY` установлен и валиден
- Проверьте `LANGCHAIN_TRACING_V2=true` (если хотите включить трейсинг)
- Проверьте логи на наличие ошибок подключения к LangSmith
- Убедитесь, что проект `LANGSMITH_PROJECT` существует в LangSmith

### Проблема: Ошибки подключения к БД
- Проверьте `DATABASE_URL` использует Internal Database URL (не Public URL)
- Убедитесь, что база данных создана и запущена

### Проблема: CORS ошибки
- Проверьте `CORS_ORIGINS` содержит ваш frontend URL
- Убедитесь, что frontend деплоится на правильный домен

### Проблема: Векторная БД не сохраняется
- Это нормально для `/tmp` директории на Render
- Рассмотрите использование внешнего хранилища (S3, etc.) для production
