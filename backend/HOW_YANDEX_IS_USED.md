# üîç –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ø–Ω–¥–µ–∫—Å –≤ –ø—Ä–æ–µ–∫—Ç–µ

## üìã –û–±—â–∞—è —Å—Ö–µ–º–∞

–Ø–Ω–¥–µ–∫—Å —Å–µ—Ä–≤–∏—Å—ã –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ **3 –∫–ª—é—á–µ–≤—ã—Ö –º–µ—Å—Ç–∞** –ø—Ä–æ–µ–∫—Ç–∞ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º fallback –Ω–∞ OpenRouter:

1. **Embeddings** (–≤–µ–∫—Ç–æ—Ä–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è) - –¥–ª—è RAG –ø–æ–∏—Å–∫–∞
2. **YandexGPT** (LLM) - –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤
3. **AI Studio Classifier** - –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

---

## 1Ô∏è‚É£ **Yandex Embeddings** - –í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

### –ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:
- **–§–∞–π–ª**: `app/services/document_processor.py`
- **–ú–µ—Ç–æ–¥**: `__init__()` (—Å—Ç—Ä–æ–∫–∞ 28-47)

### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:

```python
# –ü—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ DocumentProcessor:
if config.YANDEX_FOLDER_ID and config.YANDEX_IAM_TOKEN:
    self.embeddings = YandexEmbeddings()  # ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –Ø–Ω–¥–µ–∫—Å
else:
    self.embeddings = OpenAIEmbeddings(...)  # ‚ö†Ô∏è Fallback –Ω–∞ OpenAI
```

### –ö–æ–≥–¥–∞ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è:

1. **–ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤** (`app/routes/upload.py`):
   ```python
   # –°–æ–∑–¥–∞—é—Ç—Å—è embeddings –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —á–∞–Ω–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞
   documents = document_processor.split_documents(text, filename)
   embeddings = document_processor.create_embeddings(documents)  # ‚Üê –ó–¥–µ—Å—å!
   vector_store = document_processor.store_in_vector_db(case_id, documents)
   ```

2. **–ü—Ä–∏ –ø–æ–∏—Å–∫–µ –≤ RAG** (`app/services/rag_service.py`):
   ```python
   # –ü–æ–∏—Å–∫ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ø–æ –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   relevant_docs = document_processor.retrieve_relevant_chunks(
       case_id=case_id,
       query="–ö–∞–∫–∏–µ —Å—Ä–æ–∫–∏ –≤ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–µ?"  # ‚Üê –ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   )
   # –í–Ω—É—Ç—Ä–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è YandexEmbeddings –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ—Ö–æ–∂–∏—Ö –≤–µ–∫—Ç–æ—Ä–æ–≤
   ```

3. **–ü—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ –≤ —á–∞—Ç–µ**:
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–ù–∞–π–¥–∏ –≤—Å–µ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ —Å—Ä–æ–∫–∞—Ö"
   - –°–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Yandex embeddings –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ø-5 –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ—Ö–æ–∂–∏—Ö —á–∞–Ω–∫–æ–≤

### API –≤—ã–∑–æ–≤:
```python
# app/services/yandex_embeddings.py, —Å—Ç—Ä–æ–∫–∞ 41
POST https://llm.api.cloud.yandex.net/foundationModels/v1/textEmbedding
{
    "modelUri": "emb://{folder_id}/text-search-query/latest",
    "text": "—Ç–µ–∫—Å—Ç –¥–ª—è –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏"
}
```

---

## 2Ô∏è‚É£ **YandexGPT** - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤ –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:

#### A) **PlanningAgent** - –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á
- **–§–∞–π–ª**: `app/services/langchain_agents/planning_agent.py`
- **–ú–µ—Ç–æ–¥**: `__init__()` (—Å—Ç—Ä–æ–∫–∞ 22-49)

```python
# –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ PlanningAgent:
if config.YANDEX_FOLDER_ID and config.YANDEX_IAM_TOKEN:
    self.llm = ChatYandexGPT(...)  # ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç YandexGPT
else:
    self.llm = ChatOpenAI(...)  # ‚ö†Ô∏è Fallback –Ω–∞ OpenRouter
```

**–ö–æ–≥–¥–∞ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —á–∞—Ç–µ: "–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ –Ω–∞–π–¥–∏ —Ä–∏—Å–∫–∏"
- –°–∏—Å—Ç–µ–º–∞ –≤—ã–∑—ã–≤–∞–µ—Ç `planning_agent.plan_analysis(user_task, case_id)`
- YandexGPT –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∑–∞–¥–∞—á—É –∏ —Å–æ–∑–¥–∞–µ—Ç –ø–ª–∞–Ω –∞–Ω–∞–ª–∏–∑–æ–≤:
  ```json
  {
    "analysis_types": ["risk_analysis", "discrepancies"],
    "reasoning": "–ó–∞–¥–∞—á–∞ —Ç—Ä–µ–±—É–µ—Ç –∞–Ω–∞–ª–∏–∑–∞ —Ä–∏—Å–∫–æ–≤...",
    "confidence": 0.85
  }
  ```

#### B) **RAGService** - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤ –≤ —á–∞—Ç–µ
- **–§–∞–π–ª**: `app/services/rag_service.py`
- **–ú–µ—Ç–æ–¥**: `__init__()` (—Å—Ç—Ä–æ–∫–∞ 27-55)

```python
# –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ RAGService:
if config.YANDEX_FOLDER_ID and config.YANDEX_IAM_TOKEN:
    self.llm = ChatYandexGPT(...)  # ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç YandexGPT
else:
    self.llm = ChatOpenAI(...)  # ‚ö†Ô∏è Fallback –Ω–∞ OpenRouter
```

**–ö–æ–≥–¥–∞ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —á–∞—Ç–µ: "–ö–∞–∫–∏–µ —Å—Ä–æ–∫–∏ —É–∫–∞–∑–∞–Ω—ã –≤ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–µ?"
- –°–∏—Å—Ç–µ–º–∞:
  1. –ù–∞—Ö–æ–¥–∏—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã (—á–µ—Ä–µ–∑ Yandex embeddings)
  2. –§–æ—Ä–º–∏—Ä—É–µ—Ç –ø—Ä–æ–º–ø—Ç —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
  3. –í—ã–∑—ã–≤–∞–µ—Ç `rag_service.generate_answer(case_id, query)`
  4. YandexGPT –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

### API –≤—ã–∑–æ–≤:
```python
# app/services/yandex_llm.py, —Å—Ç—Ä–æ–∫–∞ 75
POST https://llm.api.cloud.yandex.net/foundationModels/v1/completion
{
    "modelUri": "gpt://{folder_id}/yandexgpt-pro/latest",
    "messages": [
        {"role": "user", "text": "–í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"}
    ],
    "completionOptions": {
        "temperature": 0.7,
        "maxTokens": "2000"
    }
}
```

---

## 3Ô∏è‚É£ **Yandex AI Studio Classifier** - –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

### –ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:
- **–§–∞–π–ª**: `app/services/langchain_agents/document_classifier_node.py`
- **–ú–µ—Ç–æ–¥**: `document_classifier_agent_node()` (—Å—Ç—Ä–æ–∫–∞ 62-137)

### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:

```python
# –ü—Ä–∏ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:
if config.YANDEX_FOLDER_ID and config.YANDEX_IAM_TOKEN and config.YANDEX_AI_STUDIO_CLASSIFIER_ID:
    yandex_classifier = YandexDocumentClassifier()  # ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç AI Studio
    yandex_result = yandex_classifier.classify(text=document_text)
else:
    # ‚ö†Ô∏è Fallback –Ω–∞ LLM –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—é
    classification = llm.classify(document_text)
```

### –ö–æ–≥–¥–∞ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è:

1. **–ß–µ—Ä–µ–∑ API endpoint** (`app/routes/analysis.py`, —Å—Ç—Ä–æ–∫–∞ 390):
   ```python
   POST /api/analysis/{case_id}/classify
   # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã"
   ```

2. **–ß–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—É –≤ —á–∞—Ç–µ**:
   ```
   üë§: "–ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–π –≤—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã"
   ```

3. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ**:
   - –ï—Å–ª–∏ –≤ –ø–ª–∞–Ω–µ –∞–Ω–∞–ª–∏–∑–∞ –µ—Å—Ç—å `"document_classifier"`
   - –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –≤—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –≤ –¥–µ–ª–µ

### –ü—Ä–æ—Ü–µ—Å—Å –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏:

```python
# –î–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞:
1. –ò–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è —Ç–µ–∫—Å—Ç (–ø–µ—Ä–≤—ã–µ 4000 —Å–∏–º–≤–æ–ª–æ–≤)
2. –í—ã–∑—ã–≤–∞–µ—Ç—Å—è Yandex AI Studio API:
   yandex_result = classifier.classify(
       text=document_text,
       classes=["contract", "letter", "privileged", "report", "other"]
   )
3. –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î:
   - doc_type: "contract" | "letter" | "privileged" | ...
   - confidence: 0.95
   - cost_rub: 0.11
```

### API –≤—ã–∑–æ–≤:
```python
# app/services/yandex_classifier.py, —Å—Ç—Ä–æ–∫–∞ 62
POST https://llm.api.cloud.yandex.net/foundationModels/v1/classify
{
    "model": "{classifier_id}",
    "text": "—Ç–µ–∫—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞ –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏",
    "classes": ["contract", "letter", "privileged", "report", "other"]
}
```

---

## üîÑ –ü–æ–ª–Ω—ã–π –ø–æ—Ç–æ–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü—Ä–∏–º–µ—Ä 1: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–¥–∞–µ—Ç –≤–æ–ø—Ä–æ—Å –≤ —á–∞—Ç–µ

```
üë§: "–ö–∞–∫–∏–µ —Å—Ä–æ–∫–∏ —É–∫–∞–∑–∞–Ω—ã –≤ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–µ?"
```

**–®–∞–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**

1. **–ó–∞–ø—Ä–æ—Å –ø–æ–ø–∞–¥–∞–µ—Ç –≤** `app/routes/chat.py` ‚Üí `send_message()`

2. **–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è —Ç–∏–ø –∑–∞–ø—Ä–æ—Å–∞**:
   - –ï—Å–ª–∏ —ç—Ç–æ –≤–æ–ø—Ä–æ—Å ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `RAGService`
   - –ï—Å–ª–∏ —ç—Ç–æ –∑–∞–¥–∞—á–∞ ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `PlanningAgent`

3. **RAGService –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Yandex:**
   ```python
   # 1. –ü–æ–∏—Å–∫ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (Yandex Embeddings)
   relevant_docs = rag_service.retrieve_context(
       case_id=case_id,
       query="–ö–∞–∫–∏–µ —Å—Ä–æ–∫–∏ —É–∫–∞–∑–∞–Ω—ã –≤ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–µ?"
   )
   # –í–Ω—É—Ç—Ä–∏: document_processor.retrieve_relevant_chunks()
   # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç: YandexEmbeddings –¥–ª—è –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
   
   # 2. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ (YandexGPT)
   answer, sources = rag_service.generate_answer(
       case_id=case_id,
       query="–ö–∞–∫–∏–µ —Å—Ä–æ–∫–∏ —É–∫–∞–∑–∞–Ω—ã –≤ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–µ?",
       chat_history=history
   )
   # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç: ChatYandexGPT –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞
   ```

4. **–†–µ–∑—É–ª—å—Ç–∞—Ç –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:**
   ```
   ü§ñ: "–í –∫–æ–Ω—Ç—Ä–∞–∫—Ç–µ —É–∫–∞–∑–∞–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ —Å—Ä–æ–∫–∏:
        [–î–æ–∫—É–º–µ–Ω—Ç: contract.pdf, —Å—Ç—Ä. 5, —Å—Ç—Ä–æ–∫–∏ 12-15]
        –°—Ä–æ–∫ –ø–æ—Å—Ç–∞–≤–∫–∏: 30 –¥–Ω–µ–π —Å –º–æ–º–µ–Ω—Ç–∞ –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è..."
   ```

---

### –ü—Ä–∏–º–µ—Ä 2: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—É—Å–∫–∞–µ—Ç –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—é

```
üë§: "–ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–π –≤—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã"
```

**–®–∞–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**

1. **–ó–∞–ø—Ä–æ—Å –ø–æ–ø–∞–¥–∞–µ—Ç –≤** `app/routes/analysis.py` ‚Üí `classify_documents()`

2. **–°–æ–∑–¥–∞–µ—Ç—Å—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –∞–≥–µ–Ω—Ç–∞:**
   ```python
   state = {
       "case_id": case_id,
       "classification_result": None
   }
   ```

3. **–í—ã–∑—ã–≤–∞–µ—Ç—Å—è document_classifier_node:**
   ```python
   # app/services/langchain_agents/document_classifier_node.py
   result_state = document_classifier_agent_node(state, db, ...)
   ```

4. **–î–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞:**
   ```python
   # –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Yandex
   if yandex_classifier.is_available():
       # ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Yandex AI Studio
       result = yandex_classifier.classify(text=document_text)
       # –†–µ–∑—É–ª—å—Ç–∞—Ç: {"type": "contract", "confidence": 0.95, "cost_rub": 0.11}
   else:
       # ‚ö†Ô∏è Fallback –Ω–∞ LLM
       classification = llm.classify(document_text)
   ```

5. **–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î:**
   ```python
   DocumentClassification(
       case_id=case_id,
       file_id=file.id,
       doc_type="contract",
       confidence="0.95",
       ...
   )
   ```

6. **–û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:**
   ```
   ü§ñ: "‚úÖ –ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–æ 5 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:
        - contract.pdf: contract (95% confidence, 0.11‚ÇΩ)
        - letter.pdf: privileged (92% confidence, 0.11‚ÇΩ)
        ..."
   ```

---

### –ü—Ä–∏–º–µ—Ä 3: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–µ–ª–æ

```
üë§: "–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ –Ω–∞–π–¥–∏ –≤—Å–µ —Ä–∏—Å–∫–∏"
```

**–®–∞–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**

1. **–ó–∞–ø—Ä–æ—Å –ø–æ–ø–∞–¥–∞–µ—Ç –≤** `app/routes/chat.py` ‚Üí `send_message()`

2. **–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∫–∞–∫ –∑–∞–¥–∞—á–∞** ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `PlanningAgent`

3. **PlanningAgent –∏—Å–ø–æ–ª—å–∑—É–µ—Ç YandexGPT:**
   ```python
   # app/services/langchain_agents/planning_agent.py
   plan = planning_agent.plan_analysis(
       user_task="–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ –Ω–∞–π–¥–∏ –≤—Å–µ —Ä–∏—Å–∫–∏",
       case_id=case_id
   )
   # –í–Ω—É—Ç—Ä–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è ChatYandexGPT –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∑–∞–¥–∞—á–∏
   ```

4. **YandexGPT —Å–æ–∑–¥–∞–µ—Ç –ø–ª–∞–Ω:**
   ```json
   {
     "analysis_types": ["risk_analysis", "discrepancies", "timeline"],
     "reasoning": "–ó–∞–¥–∞—á–∞ —Ç—Ä–µ–±—É–µ—Ç –∞–Ω–∞–ª–∏–∑–∞ —Ä–∏—Å–∫–æ–≤, –ø–æ—ç—Ç–æ–º—É...",
     "confidence": 0.85
   }
   ```

5. **–ü–ª–∞–Ω –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ —Ñ–æ–Ω–µ** (—á–µ—Ä–µ–∑ LangGraph –∞–≥–µ–Ω—Ç–æ–≤)

6. **–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é**

---

## üîß –ú–µ—Ö–∞–Ω–∏–∑–º Fallback

–í—Å–µ –Ø–Ω–¥–µ–∫—Å —Å–µ—Ä–≤–∏—Å—ã –∏–º–µ—é—Ç **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π fallback**:

### –£—Å–ª–æ–≤–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏:

```python
# –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–∞–ª–∏—á–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –≤ config
if config.YANDEX_FOLDER_ID and config.YANDEX_IAM_TOKEN:
    # ‚úÖ –ü—ã—Ç–∞–µ–º—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ø–Ω–¥–µ–∫—Å
    try:
        yandex_service = YandexService()
    except Exception as e:
        # ‚ö†Ô∏è –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ ‚Üí fallback
        fallback_service = OpenRouterService()
else:
    # ‚ö†Ô∏è –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω—ã –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã ‚Üí —Å—Ä–∞–∑—É fallback
    fallback_service = OpenRouterService()
```

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:

```python
# –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –Ø–Ω–¥–µ–∫—Å:
logger.info("‚úÖ Using Yandex embeddings (–ª—É—á—à–µ –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ!)")
logger.info("‚úÖ Using YandexGPT for planning (10x –¥–µ—à–µ–≤–ª–µ!)")
logger.info("‚úÖ Using Yandex AI Studio classifier (10x –±—ã—Å—Ç—Ä–µ–µ, 100x –¥–µ—à–µ–≤–ª–µ!)")

# –ü—Ä–∏ fallback:
logger.warning("Failed to initialize Yandex embeddings: {e}, falling back to OpenAI")
logger.info("Using OpenRouter for planning")
```

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ì–¥–µ –Ø–Ω–¥–µ–∫—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —á–∞—â–µ –≤—Å–µ–≥–æ:

1. **RAG –ø–æ–∏—Å–∫** (90% –∑–∞–ø—Ä–æ—Å–æ–≤):
   - –ö–∞–∂–¥—ã–π –≤–æ–ø—Ä–æ—Å –≤ —á–∞—Ç–µ ‚Üí Yandex Embeddings
   - –ö–∞–∂–¥—ã–π –æ—Ç–≤–µ—Ç ‚Üí YandexGPT

2. **–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤** (–ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ):
   - –ö–∞–∂–¥—ã–π –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç ‚Üí Yandex AI Studio (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)

3. **–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á** (20% –∑–∞–ø—Ä–æ—Å–æ–≤):
   - –°–ª–æ–∂–Ω—ã–µ –∑–∞–¥–∞—á–∏ ‚Üí YandexGPT –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

---

## üéØ –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ö–µ–º–∞

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí Chat API
    ‚Üì
–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –∑–∞–ø—Ä–æ—Å–∞
    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   –í–æ–ø—Ä–æ—Å (RAG)  ‚îÇ  –ó–∞–¥–∞—á–∞ (Plan)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚Üì                      ‚Üì
RAGService          PlanningAgent
    ‚Üì                      ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  1. Yandex Embeddings (–ø–æ–∏—Å–∫)    ‚îÇ
‚îÇ  2. YandexGPT (–æ—Ç–≤–µ—Ç)            ‚îÇ
‚îÇ  3. Yandex AI Studio (–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è) ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚Üì
–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
```

---

## ‚úÖ –í—ã–≤–æ–¥

–Ø–Ω–¥–µ–∫—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** –≤ 3 –∫–ª—é—á–µ–≤—ã—Ö –º–µ—Å—Ç–∞—Ö:

1. **Embeddings** ‚Üí –ø—Ä–∏ –∫–∞–∂–¥–æ–º –ø–æ–∏—Å–∫–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
2. **YandexGPT** ‚Üí –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤ –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏
3. **AI Studio** ‚Üí –ø—Ä–∏ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

–í—Å–µ —Å **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º fallback** –Ω–∞ OpenRouter, –µ—Å–ª–∏ –Ø–Ω–¥–µ–∫—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.

**–ù–∏–∫–∞–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –∫–æ–¥–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è** - –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤ –≤ `.env`!
