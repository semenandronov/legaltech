# Best Practices для промптов и инструментов в AI-агентах

Этот документ содержит рекомендации по созданию эффективных промптов и описаний инструментов (tools) для AI-агентов, основанные на лучших практиках от OpenAI, Anthropic, LangChain и ведущих экспертов.

---

## Содержание

1. [Когда нужен агент](#когда-нужен-агент)
2. [Структура описания инструмента](#структура-описания-инструмента)
3. [Структура системного промпта](#структура-системного-промпта)
4. [Чек-лист качества](#чек-лист-качества)
5. [Примеры](#примеры)

---

## Когда нужен агент

### ✅ Используйте агента когда:

- **Многошаговая логика** — 3+ зависимых шага для решения задачи
- **Динамичные правила** — логика часто меняется
- **Непредсказуемые входные данные** — разные форматы и типы запросов
- **Исследовательские задачи** — требуется итеративное уточнение
- **Требуется выбор инструментов** — модель должна решить, какой tool использовать

### ❌ НЕ используйте агента когда:

- **Простая классификация** — достаточно одного вызова LLM
- **Статическая логика** — фиксированный пайплайн
- **Один инструмент** — нет выбора, всегда вызывается один tool
- **Информационные задачи** — просто ответить на вопрос без действий

---

## Структура описания инструмента

Каждый инструмент (tool) должен иметь **5 обязательных компонентов**:

### 1. Конкретное название
- Понятное, однозначное имя
- Глагол + существительное: `search_documents`, `create_contract`, `analyze_risks`

### 2. Описание + примеры когда использовать
- Первая строка — краткое описание функции
- Секция "КОГДА ИСПОЛЬЗОВАТЬ" — конкретные сценарии
- Фразы-триггеры, которые указывают на этот инструмент

### 3. Параметры с типами и примерами
- Название параметра
- Тип данных (str, int, bool, enum)
- Конкретные примеры значений
- Значение по умолчанию (если есть)

### 4. Формат выходных данных
- Пример успешного ответа
- Пример ответа при ошибке
- Структура JSON (если применимо)

### 5. Guardrails (когда НЕ использовать)
- Секция "КОГДА НЕ ИСПОЛЬЗОВАТЬ"
- Перенаправление на другие инструменты
- Ограничения и исключения

---

## Структура системного промпта

Идеальный системный промпт имеет **4 компонента**:

### 1. Роль (кто ты)
```
# РОЛЬ
Ты — профессиональный юридический AI-ассистент.
```

### 2. Цель (что делать)
```
# ЦЕЛЬ
Предоставлять точные, обоснованные ответы на юридические вопросы.
```

### 3. Пошаговые инструкции (как делать)
```
# ИНСТРУКЦИИ ПО РАБОТЕ

## Шаг 1: Анализ вопроса
- Определи тип вопроса
- Выбери подходящий инструмент

## Шаг 2: Получение информации
- Вызови инструменты
- Проанализируй результаты

## Шаг 3: Формирование ответа
- Структурируй ответ
- Укажи источники
```

### 4. Guardrails (что НЕ делать)
```
# ОГРАНИЧЕНИЯ (GUARDRAILS)
- НЕ выдумывай информацию
- НЕ давай заключений без источников
- ВСЕГДА указывай источники
```

---

## Чек-лист качества

Перед деплоем проверьте каждый инструмент по этому чек-листу:

| Критерий | Вопрос | ✅/❌ |
|----------|--------|------|
| Название | Понятно ли из названия, что делает инструмент? | |
| Описание | Есть ли примеры когда использовать? | |
| Параметры | Есть ли примеры значений для каждого параметра? | |
| Выход | Показан ли пример выходных данных? | |
| Guardrails | Указано ли когда НЕ использовать? | |

**Правило:** Если ответ "НЕТ" на 3+ вопроса → переделайте описание инструмента.

---

## Примеры

### Пример хорошего описания инструмента

```python
@tool
def rag_search(query: str) -> str:
    """Поиск информации в документах дела пользователя.
    
    КОГДА ИСПОЛЬЗОВАТЬ:
    - Вопрос про документы пользователя ("мой договор", "в иске")
    - Нужны факты из конкретного дела (даты, суммы, стороны)
    - Пользователь просит проанализировать загруженные документы
    
    КОГДА НЕ ИСПОЛЬЗОВАТЬ:
    - Вопрос про законодательство → используй garant_search
    - Общий юридический вопрос без привязки к документам
    - Нужна судебная практика → используй garant_search
    
    Args:
        query: Поисковый запрос на естественном языке.
            Примеры:
            - "сумма договора"
            - "дата подписания контракта"
            - "условия расторжения"
    
    Returns:
        Формат ответа:
        "[1] Договор.pdf (стр. 3):
        Сумма договора составляет 1 500 000 рублей..."
        
        Если ничего не найдено: "Релевантные документы не найдены."
    """
```

### Пример плохого описания инструмента

```python
@tool
def search(q: str) -> str:
    """Поиск документов.
    
    Args:
        q: запрос
    
    Returns:
        результаты
    """
```

**Проблемы:**
- ❌ Непонятное название (`search` — чего?)
- ❌ Нет примеров когда использовать
- ❌ Нет примеров значений параметра
- ❌ Нет формата выходных данных
- ❌ Нет guardrails

---

## Ссылки на источники

1. [OpenAI Function Calling Best Practices](https://platform.openai.com/docs/guides/function-calling)
2. [Anthropic Tool Use Guide](https://docs.anthropic.com/claude/docs/tool-use)
3. [LangGraph ReAct Agent Tutorial](https://langchain-ai.github.io/langgraph/tutorials/introduction/)
4. [Современный ReAct-агент (Сбер/GigaChain)](https://habr.com/ru/companies/sberbank/articles/934938)
5. [LangGraph Architecture Guide](https://habr.com/ru/companies/amvera/articles/933460)

---

## Применение в проекте

Все компоненты агентской системы V2 должны следовать этим рекомендациям.

### Обновлённые файлы

**Агенты (`agents/`):**
- ✅ `chat_react_agent.py` — tools с полными описаниями, guardrails, примерами
- ✅ `tabular_extraction_agent.py` — промпты с ролью, инструкциями, ограничениями
- ✅ `workflow_orchestrator_agent.py` — промпты для всех типов шагов

**Графы (`graphs/`):**
- ✅ `chat_graph.py` — системные промпты по режимам
- ✅ `tabular_graph.py` — документация архитектуры
- ✅ `workflow_graph.py` — документация архитектуры

**Узлы (`nodes/`):**
- ✅ `discrepancy_risk_node.py` — промпты для поиска противоречий и оценки рисков
- ✅ `summary_chain.py` — промпт для генерации резюме

**Сервисы:**
- ✅ `chat_graph_service.py` — документация использования

### При добавлении нового компонента

1. **Для нового инструмента (tool):**
   - Используйте шаблон из раздела "Примеры"
   - Проверьте по чек-листу (5 критериев)
   - Добавьте КОГДА ИСПОЛЬЗОВАТЬ и КОГДА НЕ ИСПОЛЬЗОВАТЬ

2. **Для нового промпта:**
   - Добавьте секцию РОЛЬ
   - Добавьте секцию ЦЕЛЬ
   - Добавьте пошаговые ИНСТРУКЦИИ
   - Добавьте ОГРАНИЧЕНИЯ (GUARDRAILS)
   - Укажите ФОРМАТ ОТВЕТА с примером

3. **Для нового графа/узла:**
   - Документируйте архитектуру в docstring
   - Укажите КОГДА ИСПОЛЬЗОВАТЬ и КОГДА НЕ ИСПОЛЬЗОВАТЬ
   - Опишите паттерн работы

### Тестирование

После внесения изменений:
1. Проверьте отсутствие linter ошибок
2. Протестируйте на реальных запросах
3. Убедитесь, что модель правильно выбирает инструменты
4. Проверьте формат выходных данных

