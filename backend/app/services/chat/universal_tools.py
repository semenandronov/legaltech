"""
Universal Tools - 12 —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è ReAct Chat Agent

–ê–≥–µ–Ω—Ç –°–ê–ú —Ä–µ—à–∞–µ—Ç, –∫–∞–∫–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –≤—ã–∑–≤–∞—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–æ–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
–ö–∞–∂–¥—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∏–º–µ–µ—Ç –ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è LLM.

–ë–õ–û–ö 1: –†–∞–±–æ—Ç–∞ —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏ (4 –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞)
- get_document: –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞
- search_in_documents: –ø–æ–∏—Å–∫ –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º
- extract_structured_data: –∏–∑–≤–ª–µ—á—å –¥–∞—Ç—ã/—Å—É–º–º—ã/–∏–º–µ–Ω–∞
- compare_documents: —Å—Ä–∞–≤–Ω–∏—Ç—å –¥–≤–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞

–ë–õ–û–ö 2: –ó–∞–∫–æ–Ω—ã (2 –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞)
- search_garant: –ø–æ–∏—Å–∫ –≤ –±–∞–∑–µ –∑–∞–∫–æ–Ω–æ–≤
- get_law_article: –ø–æ–ª—É—á–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Å—Ç–∞—Ç—å—é

–ë–õ–û–ö 3: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (2 –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞)
- generate_document: —Å–æ–∑–¥–∞—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫
- list_templates: –ø–æ–∫–∞–∑–∞—Ç—å —à–∞–±–ª–æ–Ω—ã

–ë–õ–û–ö 4: Playbook (2 –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞)
- validate_with_playbook: –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º
- get_user_playbooks: —Å–ø–∏—Å–æ–∫ –ø—Ä–∞–≤–∏–ª

–ë–õ–û–ö 5: –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ (2 –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞)
- calculate: —Ä–∞—Å—á–µ—Ç—ã
- get_current_date: —Ç–µ–∫—É—â–∞—è –¥–∞—Ç–∞
"""
from typing import List, Optional
from langchain_core.tools import tool
from sqlalchemy.orm import Session
from datetime import datetime
import logging
import re

logger = logging.getLogger(__name__)

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–∏–Ω–∂–µ–∫—Ç–∏—Ä—É—é—Ç—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ tools)
_db: Optional[Session] = None
_rag_service = None
_case_id: Optional[str] = None
_user_id: Optional[str] = None


def initialize_universal_tools(
    db: Session, 
    rag_service, 
    case_id: str,
    user_id: Optional[str] = None
):
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è tools"""
    global _db, _rag_service, _case_id, _user_id
    _db = db
    _rag_service = rag_service
    _case_id = case_id
    _user_id = user_id


# =============================================================================
# –ë–õ–û–ö 1: –†–ê–ë–û–¢–ê –° –î–û–ö–£–ú–ï–ù–¢–ê–ú–ò (4 –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞)
# =============================================================================

@tool
def get_document(filename: str) -> str:
    """
    –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞ –ø–æ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞.
    
    –ö–û–ì–î–ê –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨:
    - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç –ø–æ–∫–∞–∑–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç
    - –ù—É–∂–µ–Ω –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
    - –í–æ–ø—Ä–æ—Å —Ç–∏–ø–∞ "–ø–æ–∫–∞–∂–∏ –¥–æ–≥–æ–≤–æ—Ä", "–æ—Ç–∫—Ä–æ–π –∏—Å–∫", "—á—Ç–æ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ X"
    - –ü–µ—Ä–µ–¥ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ–º –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
    
    –ù–ï –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨:
    - –î–ª—è –ø–æ–∏—Å–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (–∏—Å–ø–æ–ª—å–∑—É–π search_in_documents)
    - –ï—Å–ª–∏ –Ω—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç (–∏—Å–ø–æ–ª—å–∑—É–π search_in_documents)
    
    Args:
        filename: –ò–º—è —Ñ–∞–π–ª–∞ (–ø–æ–ª–Ω–æ–µ –∏–ª–∏ —á–∞—Å—Ç–∏—á–Ω–æ–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä "–¥–æ–≥–æ–≤–æ—Ä" –∏–ª–∏ "–¥–æ–≥–æ–≤–æ—Ä.pdf")
    
    Returns:
        –ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–¥–æ 15000 —Å–∏–º–≤–æ–ª–æ–≤) –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
    """
    global _db, _case_id
    
    if not _db or not _case_id:
        return "–û—à–∏–±–∫–∞: –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞"
    
    try:
        from app.models.case import File as FileModel
        
        # –ò—â–µ–º —Ñ–∞–π–ª –ø–æ —á–∞—Å—Ç–∏—á–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é –∏–º–µ–Ω–∏
        files = _db.query(FileModel).filter(
            FileModel.case_id == _case_id
        ).all()
        
        if not files:
            return "–í –¥–µ–ª–µ –Ω–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤."
        
        # –ò—â–µ–º —Ñ–∞–π–ª –ø–æ –∏–º–µ–Ω–∏ (—á–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ)
        filename_lower = filename.lower()
        matched_file = None
        
        for f in files:
            if filename_lower in f.filename.lower():
                matched_file = f
                break
        
        if not matched_file:
            # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
            file_list = "\n".join([f"- {f.filename}" for f in files])
            return f"–î–æ–∫—É–º–µ–Ω—Ç '{filename}' –Ω–µ –Ω–∞–π–¥–µ–Ω.\n\n–î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã:\n{file_list}"
        
        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞
        text = matched_file.original_text or ""
        
        if not text:
            return f"–î–æ–∫—É–º–µ–Ω—Ç '{matched_file.filename}' –Ω–∞–π–¥–µ–Ω, –Ω–æ —Ç–µ–∫—Å—Ç –ø—É—Å—Ç."
        
        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä
        if len(text) > 15000:
            text = text[:15000] + "\n\n... [—Ç–µ–∫—Å—Ç –æ–±—Ä–µ–∑–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–π search_in_documents –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏]"
        
        logger.info(f"[UniversalTools] get_document: {matched_file.filename} ({len(text)} —Å–∏–º–≤–æ–ª–æ–≤)")
        return f"üìÑ **{matched_file.filename}**\n\n{text}"
        
    except Exception as e:
        logger.error(f"[UniversalTools] get_document error: {e}")
        return f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞: {str(e)}"


@tool
def search_in_documents(query: str, k: int = 20) -> str:
    """
    –ü–æ–∏—Å–∫ –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º –¥–µ–ª–∞. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã —Å –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏.
    
    Args:
        query: –ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
        k: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (5-100, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 20)
    
    Returns:
        –ù–∞–π–¥–µ–Ω–Ω—ã–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —Å –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏
    """
    global _rag_service, _case_id, _db
    
    if not _rag_service or not _case_id:
        return "–û—à–∏–±–∫–∞: —Å–µ—Ä–≤–∏—Å –ø–æ–∏—Å–∫–∞ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω"
    
    try:
        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º k —Ä–∞–∑—É–º–Ω—ã–º–∏ –ø—Ä–µ–¥–µ–ª–∞–º–∏
        k = max(5, min(100, k))
        
        documents = _rag_service.retrieve_context(
            case_id=_case_id,
            query=query,
            k=k,
            retrieval_strategy="multi_query",
            db=_db
        )
        
        if not documents:
            return f"–ü–æ –∑–∞–ø—Ä–æ—Å—É '{query}' –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö –¥–µ–ª–∞."
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã - —É–≤–µ–ª–∏—á–µ–Ω –ª–∏–º–∏—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        # –∏ —É–ª—É—á—à–µ–Ω —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –ª—É—á—à–µ–≥–æ –ø–æ–Ω–∏–º–∞–Ω–∏—è LLM
        result_parts = []
        total_chars = 0
        max_chars = 25000  # –£–≤–µ–ª–∏—á–µ–Ω –ª–∏–º–∏—Ç
        
        for i, doc in enumerate(documents, 1):
            if total_chars >= max_chars:
                break
                
            metadata = doc.metadata
            source_file = metadata.get("source_file", "–î–æ–∫—É–º–µ–Ω—Ç")
            content = doc.page_content.strip()
            
            # –§–æ—Ä–º–∞—Ç: –Ω–æ–º–µ—Ä, –∏—Å—Ç–æ—á–Ω–∏–∫, –∫–æ–Ω—Ç–µ–Ω—Ç
            entry = f"[{i}] {source_file}:\n{content}"
            
            if total_chars + len(entry) > max_chars:
                # –û–±—Ä–µ–∑–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–æ–∫—É–º–µ–Ω—Ç –µ—Å–ª–∏ –Ω–µ –≤–ª–µ–∑–∞–µ—Ç
                available = max_chars - total_chars - 100
                if available > 200:
                    entry = f"[{i}] {source_file}:\n{content[:available]}..."
                else:
                    break
            
            result_parts.append(entry)
            total_chars += len(entry)
        
        logger.info(f"[UniversalTools] search_in_documents: –Ω–∞–π–¥–µ–Ω–æ {len(documents)} —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤, –≤–µ—Ä–Ω—É–ª–∏ {len(result_parts)} –¥–ª—è '{query[:50]}...'")
        
        return f"–ù–∞–π–¥–µ–Ω–æ {len(documents)} —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö:\n\n" + "\n\n".join(result_parts)
        
    except Exception as e:
        logger.error(f"[UniversalTools] search_in_documents error: {e}")
        return f"–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: {str(e)}"


@tool
def extract_structured_data(entity_types: str = "dates,amounts,persons,organizations") -> str:
    """
    –ò–∑–≤–ª–µ—á—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –¥–µ–ª–∞.
    
    –ö–û–ì–î–ê –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨:
    - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç "–∫–∞–∫–∏–µ –¥–∞—Ç—ã", "–∫–∞–∫–∏–µ —Å—É–º–º—ã", "–∫—Ç–æ —É—á–∞—Å—Ç–Ω–∏–∫–∏"
    - –ù—É–∂–µ–Ω —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –¥–∞—Ç/—Å—É–º–º/–∏–º—ë–Ω/–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π
    - –î–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –æ–±–∑–æ—Ä–∞ –∫–ª—é—á–µ–≤—ã—Ö —Ñ–∞–∫—Ç–æ–≤
    
    Args:
        entity_types: –¢–∏–ø—ã —Å—É—â–Ω–æ—Å—Ç–µ–π —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é:
            - dates: –¥–∞—Ç—ã (–¥–æ–≥–æ–≤–æ—Ä—ã, —Å—Ä–æ–∫–∏, —Å–æ–±—ã—Ç–∏—è)
            - amounts: —Å—É–º–º—ã (—Ü–µ–Ω—ã, —à—Ç—Ä–∞—Ñ—ã, –ø–µ–Ω–∏)
            - persons: –∏–º–µ–Ω–∞ –ª—é–¥–µ–π (—Å—Ç–æ—Ä–æ–Ω—ã, –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª–∏)
            - organizations: –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ (–∫–æ–º–ø–∞–Ω–∏–∏, —Å—É–¥—ã)
    
    Returns:
        –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
    """
    global _rag_service, _case_id, _db
    
    if not _rag_service or not _case_id:
        return "–û—à–∏–±–∫–∞: —Å–µ—Ä–≤–∏—Å –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω"
    
    try:
        from app.services.llm_factory import create_legal_llm
        from langchain_core.messages import HumanMessage, SystemMessage
        
        # –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
        documents = _rag_service.retrieve_context(
            case_id=_case_id,
            query="–∫–ª—é—á–µ–≤—ã–µ —Ñ–∞–∫—Ç—ã –¥–∞—Ç—ã —Å—É–º–º—ã –∏–º–µ–Ω–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏",
            k=50,
            db=_db
        )
        
        if not documents:
            return "–î–æ–∫—É–º–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö."
        
        context = "\n".join([d.page_content for d in documents])[:12000]
        
        # –ü–∞—Ä—Å–∏–º —Ç–∏–ø—ã —Å—É—â–Ω–æ—Å—Ç–µ–π
        types_list = [t.strip() for t in entity_types.split(",")]
        
        prompt = f"""–ò–∑–≤–ª–µ–∫–∏ –∏–∑ —Ç–µ–∫—Å—Ç–∞ —Å–ª–µ–¥—É—é—â–∏–µ —Å—É—â–Ω–æ—Å—Ç–∏: {', '.join(types_list)}

–¢–µ–∫—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:
{context}

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ (—Ç–æ–ª—å–∫–æ —Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–ø—Ä–æ—à–µ–Ω—ã):
"""
        if "dates" in types_list:
            prompt += "\nüìÖ –î–ê–¢–´:\n- [–¥–∞—Ç–∞]: [–∫–æ–Ω—Ç–µ–∫—Å—Ç/—Å–æ–±—ã—Ç–∏–µ]"
        if "amounts" in types_list:
            prompt += "\n\nüí∞ –°–£–ú–ú–´:\n- [—Å—É–º–º–∞]: [–∫–æ–Ω—Ç–µ–∫—Å—Ç]"
        if "persons" in types_list:
            prompt += "\n\nüë§ –õ–ò–¶–ê:\n- [–∏–º—è]: [—Ä–æ–ª—å]"
        if "organizations" in types_list:
            prompt += "\n\nüè¢ –û–†–ì–ê–ù–ò–ó–ê–¶–ò–ò:\n- [–Ω–∞–∑–≤–∞–Ω–∏–µ]: [—Ä–æ–ª—å]"
        
        prompt += "\n\n–ï—Å–ª–∏ —Å—É—â–Ω–æ—Å—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ - –Ω–∞–ø–∏—à–∏ '–Ω–µ –Ω–∞–π–¥–µ–Ω–æ'."
        
        llm = create_legal_llm()
        response = llm.invoke([
            SystemMessage(content="–¢—ã –∏–∑–≤–ª–µ–∫–∞–µ—à—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤. –ë—É–¥—å —Ç–æ—á–µ–Ω."),
            HumanMessage(content=prompt)
        ])
        
        result = response.content if hasattr(response, 'content') else str(response)
        logger.info(f"[UniversalTools] extract_structured_data: –∏–∑–≤–ª–µ—á–µ–Ω—ã {entity_types}")
        
        return result
        
    except Exception as e:
        logger.error(f"[UniversalTools] extract_structured_data error: {e}")
        return f"–û—à–∏–±–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö: {str(e)}"


@tool
def compare_documents(doc1_name: str, doc2_name: str) -> str:
    """
    –°—Ä–∞–≤–Ω–∏—Ç—å –¥–≤–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏ –Ω–∞–π—Ç–∏ —Ä–∞–∑–ª–∏—á–∏—è/–ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è.
    
    –ö–û–ì–î–ê –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨:
    - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç —Å—Ä–∞–≤–Ω–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã
    - –ù—É–∂–Ω–æ –Ω–∞–π—Ç–∏ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è –º–µ–∂–¥—É –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏
    - –í–æ–ø—Ä–æ—Å—ã —Ç–∏–ø–∞ "—á–µ–º –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –¥–æ–≥–æ–≤–æ—Ä –æ—Ç –∞–∫—Ç–∞"
    
    Args:
        doc1_name: –ò–º—è –ø–µ—Ä–≤–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–∏–ª–∏ —á–∞—Å—Ç—å –∏–º–µ–Ω–∏)
        doc2_name: –ò–º—è –≤—Ç–æ—Ä–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–∏–ª–∏ —á–∞—Å—Ç—å –∏–º–µ–Ω–∏)
    
    Returns:
        –°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –¥–≤—É—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —Ä–∞–∑–ª–∏—á–∏–π
    """
    global _db, _case_id, _rag_service
    
    if not _db or not _case_id:
        return "–û—à–∏–±–∫–∞: –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞"
    
    try:
        from app.models.case import File as FileModel
        from app.services.llm_factory import create_legal_llm
        from langchain_core.messages import HumanMessage, SystemMessage
        
        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Ñ–∞–π–ª—ã
        files = _db.query(FileModel).filter(FileModel.case_id == _case_id).all()
        
        if not files:
            return "–í –¥–µ–ª–µ –Ω–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è."
        
        # –ò—â–µ–º –ø–µ—Ä–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç
        doc1 = None
        doc1_name_lower = doc1_name.lower()
        for f in files:
            if doc1_name_lower in f.filename.lower():
                doc1 = f
                break
        
        # –ò—â–µ–º –≤—Ç–æ—Ä–æ–π –¥–æ–∫—É–º–µ–Ω—Ç
        doc2 = None
        doc2_name_lower = doc2_name.lower()
        for f in files:
            if doc2_name_lower in f.filename.lower():
                doc2 = f
                break
        
        if not doc1:
            return f"–î–æ–∫—É–º–µ–Ω—Ç '{doc1_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω."
        if not doc2:
            return f"–î–æ–∫—É–º–µ–Ω—Ç '{doc2_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω."
        
        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç—ã (–æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä)
        text1 = (doc1.original_text or "")[:6000]
        text2 = (doc2.original_text or "")[:6000]
        
        prompt = f"""–°—Ä–∞–≤–Ω–∏ –¥–≤–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏ –Ω–∞–π–¥–∏:
1. –ö–ª—é—á–µ–≤—ã–µ —Ä–∞–∑–ª–∏—á–∏—è
2. –ü—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å)
3. –û–±—â–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã

–î–û–ö–£–ú–ï–ù–¢ 1: {doc1.filename}
{text1}

–î–û–ö–£–ú–ï–ù–¢ 2: {doc2.filename}
{text2}

–î–∞–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑."""

        llm = create_legal_llm()
        response = llm.invoke([
            SystemMessage(content="–¢—ã —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏—Ç–∏–∫. –°—Ä–∞–≤–Ω–∏–≤–∞–µ—à—å –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ –Ω–∞—Ö–æ–¥–∏—à—å —Ä–∞–∑–ª–∏—á–∏—è."),
            HumanMessage(content=prompt)
        ])
        
        result = response.content if hasattr(response, 'content') else str(response)
        logger.info(f"[UniversalTools] compare_documents: {doc1.filename} vs {doc2.filename}")
        
        return f"üìä **–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤**\n\n{result}"
        
    except Exception as e:
        logger.error(f"[UniversalTools] compare_documents error: {e}")
        return f"–û—à–∏–±–∫–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è: {str(e)}"


# =============================================================================
# –ë–õ–û–ö 2: –ó–ê–ö–û–ù–´ (2 –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞)
# =============================================================================

@tool
def search_garant(query: str, doc_type: str = "all", max_results: int = 10) -> str:
    """
    –ü–æ–∏—Å–∫ –≤ –ø—Ä–∞–≤–æ–≤–æ–π –±–∞–∑–µ –ì–ê–†–ê–ù–¢.
    
    –ö–û–ì–î–ê –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨:
    - –ù—É–∂–Ω–∞ —Å—Ç–∞—Ç—å—è –∫–æ–¥–µ–∫—Å–∞ (–ì–ö, –ì–ü–ö, –ê–ü–ö, –£–ö, –ù–ö)
    - –ù—É–∂–µ–Ω –∑–∞–∫–æ–Ω –∏–ª–∏ –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π –∞–∫—Ç
    - –ù—É–∂–Ω–æ —Å—É–¥–µ–±–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –∏–ª–∏ –ø—Ä–∞–∫—Ç–∏–∫–∞
    - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø—Ä–æ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ
    
    –ù–ï –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨:
    - –î–ª—è –ø–æ–∏—Å–∫–∞ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∏—Å–ø–æ–ª—å–∑—É–π search_in_documents)
    - –ö–æ–≥–¥–∞ –≤–æ–ø—Ä–æ—Å –ø—Ä–æ "–º–æ–π –¥–æ–≥–æ–≤–æ—Ä", "–≤ –∏—Å–∫–µ" –∏ —Ç.–¥.
    
    Args:
        query: –ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä: "—Å—Ç–∞—Ç—å—è 393 –ì–ö –†–§", "–≤–æ–∑–º–µ—â–µ–Ω–∏–µ —É–±—ã—Ç–∫–æ–≤")
        doc_type: –¢–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞:
            - all: –≤—Å–µ —Ç–∏–ø—ã (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
            - law: –∑–∞–∫–æ–Ω—ã –∏ –∫–æ–¥–µ–∫—Å—ã
            - court_decision: —Å—É–¥–µ–±–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è
            - article: —Å—Ç–∞—Ç—å–∏ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
        max_results: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (1-20)
    
    Returns:
        –ù–∞–π–¥–µ–Ω–Ω—ã–µ –Ω–æ—Ä–º—ã –ø—Ä–∞–≤–∞ —Å —Ü–∏—Ç–∞—Ç–∞–º–∏ –∏ —Å—Å—ã–ª–∫–∞–º–∏
    """
    try:
        from app.services.langchain_agents.garant_tools import search_garant as _search_garant
        
        logger.info(f"[UniversalTools] search_garant: {query[:50]}... (type={doc_type})")
        result = _search_garant.invoke({
            "query": query,
            "doc_type": doc_type,
            "max_results": min(20, max(1, max_results))
        })
        
        return result
        
    except ImportError:
        return "‚ö†Ô∏è –ü–æ–∏—Å–∫ –≤ –ì–ê–†–ê–ù–¢ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –§—É–Ω–∫—Ü–∏—è –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞."
    except Exception as e:
        logger.error(f"[UniversalTools] search_garant error: {e}")
        return f"–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –≤ –ì–ê–†–ê–ù–¢: {str(e)}"


@tool
def get_law_article(article_ref: str) -> str:
    """
    –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å—Ç–∞—Ç—å–∏ –∑–∞–∫–æ–Ω–∞.
    
    –ö–û–ì–î–ê –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨:
    - –ù—É–∂–µ–Ω –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—å–∏ (–ø–æ—Å–ª–µ search_garant)
    - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç "–ø–æ–∫–∞–∂–∏ —Å—Ç–∞—Ç—å—é 395 –ì–ö"
    - –ù—É–∂–Ω—ã –¥–µ—Ç–∞–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –Ω–æ—Ä–º—ã
    
    Args:
        article_ref: –°—Å—ã–ª–∫–∞ –Ω–∞ —Å—Ç–∞—Ç—å—é (–Ω–∞–ø—Ä–∏–º–µ—Ä: "—Å—Ç. 393 –ì–ö –†–§", "—Å—Ç–∞—Ç—å—è 15 –ó–∞–∫–æ–Ω–∞ –æ –∑–∞—â–∏—Ç–µ –ø—Ä–∞–≤ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–π")
    
    Returns:
        –ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—å–∏ —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏
    """
    try:
        from app.services.langchain_agents.garant_tools import get_garant_full_text
        
        logger.info(f"[UniversalTools] get_law_article: {article_ref}")
        result = get_garant_full_text.invoke({"doc_id": article_ref})
        
        return result
        
    except ImportError:
        return "‚ö†Ô∏è –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–µ–π –∏–∑ –ì–ê–†–ê–ù–¢ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ."
    except Exception as e:
        logger.error(f"[UniversalTools] get_law_article error: {e}")
        return f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—å–∏: {str(e)}"


# =============================================================================
# –ë–õ–û–ö 3: –ì–ï–ù–ï–†–ê–¶–ò–Ø –î–û–ö–£–ú–ï–ù–¢–û–í (2 –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞)
# =============================================================================

@tool
def generate_document(doc_type: str, variables: str = "") -> str:
    """
    –°–æ–∑–¥–∞—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫ —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞.
    
    –ö–û–ì–î–ê –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨:
    - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç —Å–æ–∑–¥–∞—Ç—å/—Å–æ—Å—Ç–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç
    - –ù—É–∂–µ–Ω —á–µ—Ä–Ω–æ–≤–∏–∫ –¥–æ–≥–æ–≤–æ—Ä–∞, –∏—Å–∫–∞, –ø—Ä–µ—Ç–µ–Ω–∑–∏–∏
    - –í–æ–ø—Ä–æ—Å—ã —Ç–∏–ø–∞ "—Å–æ—Å—Ç–∞–≤—å", "–Ω–∞–ø–∏—à–∏", "—Å–æ–∑–¥–∞–π"
    
    Args:
        doc_type: –¢–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞:
            - contract: –¥–æ–≥–æ–≤–æ—Ä
            - claim: –∏—Å–∫–æ–≤–æ–µ –∑–∞—è–≤–ª–µ–Ω–∏–µ
            - pretension: –ø—Ä–µ—Ç–µ–Ω–∑–∏—è
            - letter: –¥–µ–ª–æ–≤–æ–µ –ø–∏—Å—å–º–æ
            - memo: —Å–ª—É–∂–µ–±–Ω–∞—è –∑–∞–ø–∏—Å–∫–∞
            - power_of_attorney: –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å
            - agreement: —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ
            - protocol: –ø—Ä–æ—Ç–æ–∫–æ–ª
            - act: –∞–∫—Ç
        variables: –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ "–∫–ª—é—á=–∑–Ω–∞—á–µ–Ω–∏–µ; –∫–ª—é—á2=–∑–Ω–∞—á–µ–Ω–∏–µ2"
            –ù–∞–ø—Ä–∏–º–µ—Ä: "–∏—Å—Ç–µ—Ü=–û–û–û –†–æ–º–∞—à–∫–∞; –æ—Ç–≤–µ—Ç—á–∏–∫=–ò–ü –ò–≤–∞–Ω–æ–≤; —Å—É–º–º–∞=100000"
    
    Returns:
        –ß–µ—Ä–Ω–æ–≤–∏–∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ Markdown
    """
    global _db, _case_id, _rag_service
    
    try:
        from app.services.llm_factory import create_legal_llm
        from langchain_core.messages import HumanMessage, SystemMessage
        
        # –ü–∞—Ä—Å–∏–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        vars_dict = {}
        if variables:
            for pair in variables.split(";"):
                if "=" in pair:
                    key, value = pair.split("=", 1)
                    vars_dict[key.strip()] = value.strip()
        
        # –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –¥–µ–ª–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
        context = ""
        if _rag_service and _case_id and _db:
            try:
                docs = _rag_service.retrieve_context(
                    case_id=_case_id,
                    query=f"–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è {doc_type}",
                    k=10,
                    db=_db
                )
                if docs:
                    context = "\n".join([d.page_content for d in docs])[:4000]
            except:
                pass
        
        # –®–∞–±–ª–æ–Ω—ã —Ä–∞–∑–¥–µ–ª–æ–≤ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤
        templates = {
            "contract": ["–ü—Ä–µ–∞–º–±—É–ª–∞", "–ü—Ä–µ–¥–º–µ—Ç –¥–æ–≥–æ–≤–æ—Ä–∞", "–ü—Ä–∞–≤–∞ –∏ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏", "–¶–µ–Ω–∞ –∏ —Ä–∞—Å—á—ë—Ç—ã", "–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å", "–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è", "–†–µ–∫–≤–∏–∑–∏—Ç—ã"],
            "claim": ["–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Å—É–¥–∞", "–ò—Å—Ç–µ—Ü", "–û—Ç–≤–µ—Ç—á–∏–∫", "–¶–µ–Ω–∞ –∏—Å–∫–∞", "–û–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞", "–ü—Ä–∞–≤–æ–≤–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ", "–ü—Ä–æ—Å–∏—Ç–µ–ª—å–Ω–∞—è —á–∞—Å—Ç—å", "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è"],
            "pretension": ["–ê–¥—Ä–µ—Å–∞—Ç", "–û—Ç –∫–æ–≥–æ", "–û–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞", "–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è", "–°—Ä–æ–∫ –æ—Ç–≤–µ—Ç–∞", "–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è"],
            "letter": ["–ê–¥—Ä–µ—Å–∞—Ç", "–¢–µ–º–∞", "–í—Å—Ç—É–ø–ª–µ–Ω–∏–µ", "–û—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å", "–ó–∞–∫–ª—é—á–µ–Ω–∏–µ"],
            "memo": ["–ê–¥—Ä–µ—Å–∞—Ç", "–û—Ç –∫–æ–≥–æ", "–¢–µ–º–∞", "–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ", "–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è"],
            "power_of_attorney": ["–î–æ–≤–µ—Ä–∏—Ç–µ–ª—å", "–ü—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—å", "–ü–æ–ª–Ω–æ–º–æ—á–∏—è", "–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è"],
            "agreement": ["–°—Ç–æ—Ä–æ–Ω—ã", "–ü—Ä–µ–¥–º–µ—Ç", "–£—Å–ª–æ–≤–∏—è", "–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å", "–ó–∞–∫–ª—é—á–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª–æ–∂–µ–Ω–∏—è"],
            "protocol": ["–î–∞—Ç–∞ –∏ –º–µ—Å—Ç–æ", "–ü—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ", "–ü–æ–≤–µ—Å—Ç–∫–∞ –¥–Ω—è", "–°–ª—É—à–∞–ª–∏", "–†–µ—à–∏–ª–∏"],
            "act": ["–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ", "–î–∞—Ç–∞", "–ö–æ–º–∏—Å—Å–∏—è", "–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ", "–ó–∞–∫–ª—é—á–µ–Ω–∏–µ"]
        }
        
        sections = templates.get(doc_type, ["–í–≤–µ–¥–µ–Ω–∏–µ", "–û—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å", "–ó–∞–∫–ª—é—á–µ–Ω–∏–µ"])
        
        prompt = f"""–°–æ–∑–¥–∞–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –¥–æ–∫—É–º–µ–Ω—Ç.

–¢–ò–ü: {doc_type}
–†–ê–ó–î–ï–õ–´: {', '.join(sections)}

–ü–ï–†–ï–ú–ï–ù–ù–´–ï:
{chr(10).join([f'- {k}: {v}' for k, v in vars_dict.items()]) if vars_dict else '–ù–µ —É–∫–∞–∑–∞–Ω—ã'}

–ö–û–ù–¢–ï–ö–°–¢ –ò–ó –î–ï–õ–ê:
{context if context else '–ù–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞'}

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
1. –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π —Å—Ç–∏–ª—å
2. –í—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã
3. –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—è
4. –ú–µ—Å—Ç–∞ –¥–ª—è –ø–æ–¥–ø–∏—Å–µ–π –∏ –¥–∞—Ç
5. –§–æ—Ä–º–∞—Ç Markdown

–°–æ–∑–¥–∞–π –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞:"""

        llm = create_legal_llm()
        response = llm.invoke([
            SystemMessage(content="–¢—ã –æ–ø—ã—Ç–Ω—ã–π —é—Ä–∏—Å—Ç, —Å–æ—Å—Ç–∞–≤–ª—è—é—â–∏–π —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã."),
            HumanMessage(content=prompt)
        ])
        
        result = response.content if hasattr(response, 'content') else str(response)
        logger.info(f"[UniversalTools] generate_document: {doc_type}")
        
        return f"üìù **–ß–µ—Ä–Ω–æ–≤–∏–∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞: {doc_type}**\n\n{result}\n\n---\n‚ö†Ô∏è *–≠—Ç–æ —á–µ—Ä–Ω–æ–≤–∏–∫. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º.*"
        
    except Exception as e:
        logger.error(f"[UniversalTools] generate_document error: {e}")
        return f"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞: {str(e)}"


@tool
def list_templates() -> str:
    """
    –ü–æ–∫–∞–∑–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.
    
    –ö–û–ì–î–ê –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨:
    - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç "–∫–∞–∫–∏–µ —à–∞–±–ª–æ–Ω—ã –µ—Å—Ç—å"
    - –ü–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –¥–æ–∫—É–º–µ–Ω—Ç–∞ (—á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —Ç–∏–ø)
    - –ù—É–∂–µ–Ω —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–∏–ø–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
    
    Returns:
        –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤ —Å –æ–ø–∏—Å–∞–Ω–∏—è–º–∏
    """
    templates = """
üìã **–î–æ—Å—Ç—É–ø–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:**

**–î–æ–≥–æ–≤–æ—Ä—ã –∏ —Å–æ–≥–ª–∞—à–µ–Ω–∏—è:**
- `contract` ‚Äî –î–æ–≥–æ–≤–æ—Ä (–∫—É–ø–ª–∏-–ø—Ä–æ–¥–∞–∂–∏, –ø–æ—Å—Ç–∞–≤–∫–∏, —É—Å–ª—É–≥ –∏ –¥—Ä.)
- `agreement` ‚Äî –°–æ–≥–ª–∞—à–µ–Ω–∏–µ (–º–∏—Ä–æ–≤–æ–µ, –æ —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–µ –∏ –¥—Ä.)

**–°—É–¥–µ–±–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã:**
- `claim` ‚Äî –ò—Å–∫–æ–≤–æ–µ –∑–∞—è–≤–ª–µ–Ω–∏–µ
- `pretension` ‚Äî –ü—Ä–µ—Ç–µ–Ω–∑–∏—è (–¥–æ—Å—É–¥–µ–±–Ω–∞—è)

**–î–µ–ª–æ–≤–∞—è –ø–µ—Ä–µ–ø–∏—Å–∫–∞:**
- `letter` ‚Äî –î–µ–ª–æ–≤–æ–µ –ø–∏—Å—å–º–æ
- `memo` ‚Äî –°–ª—É–∂–µ–±–Ω–∞—è –∑–∞–ø–∏—Å–∫–∞

**–ü—Ä–æ—á–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã:**
- `power_of_attorney` ‚Äî –î–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å
- `protocol` ‚Äî –ü—Ä–æ—Ç–æ–∫–æ–ª (—Å–æ–±—Ä–∞–Ω–∏—è, –∑–∞—Å–µ–¥–∞–Ω–∏—è)
- `act` ‚Äî –ê–∫—Ç (–ø—Ä–∏—ë–º–∞-–ø–µ—Ä–µ–¥–∞—á–∏, —Å–≤–µ—Ä–∫–∏ –∏ –¥—Ä.)

---
üí° –î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–π: `generate_document(doc_type, variables)`

–ü—Ä–∏–º–µ—Ä: `generate_document("claim", "–∏—Å—Ç–µ—Ü=–û–û–û –†–æ–º–∞—à–∫–∞; –æ—Ç–≤–µ—Ç—á–∏–∫=–ò–ü –ò–≤–∞–Ω–æ–≤; —Å—É–º–º–∞=100000")`
"""
    logger.info("[UniversalTools] list_templates called")
    return templates


# =============================================================================
# –ë–õ–û–ö 4: PLAYBOOK (2 –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞)
# =============================================================================

@tool
def validate_with_playbook(document_name: str, playbook_name: str = "") -> str:
    """
    –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø—Ä–∞–≤–∏–ª–∞–º Playbook.
    
    –ö–û–ì–î–ê –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨:
    - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º
    - –ù—É–∂–µ–Ω compliance check
    - –í–æ–ø—Ä–æ—Å—ã —Ç–∏–ø–∞ "–ø—Ä–æ–≤–µ—Ä—å –¥–æ–≥–æ–≤–æ—Ä", "—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–∏..."
    
    Args:
        document_name: –ò–º—è –¥–æ–∫—É–º–µ–Ω—Ç–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
        playbook_name: –ò–º—è playbook (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è default)
    
    Returns:
        –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –Ω–∞—Ä—É—à–µ–Ω–∏–π –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
    """
    global _db, _case_id, _user_id
    
    if not _db or not _case_id:
        return "–û—à–∏–±–∫–∞: –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞"
    
    try:
        from app.models.case import File as FileModel
        from app.services.playbook_service import PlaybookService
        from app.services.llm_factory import create_legal_llm
        from langchain_core.messages import HumanMessage, SystemMessage
        
        # –ò—â–µ–º –¥–æ–∫—É–º–µ–Ω—Ç
        files = _db.query(FileModel).filter(FileModel.case_id == _case_id).all()
        doc = None
        doc_name_lower = document_name.lower()
        for f in files:
            if doc_name_lower in f.filename.lower():
                doc = f
                break
        
        if not doc:
            return f"–î–æ–∫—É–º–µ–Ω—Ç '{document_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω."
        
        # –ü–æ–ª—É—á–∞–µ–º playbooks
        playbook_service = PlaybookService(_db)
        playbooks = playbook_service.get_playbooks(
            user_id=_user_id or "system",
            include_system=True,
            include_public=True,
            limit=10
        )
        
        if not playbooks:
            # –ï—Å–ª–∏ –Ω–µ—Ç playbooks - –¥–µ–ª–∞–µ–º –±–∞–∑–æ–≤—É—é –ø—Ä–æ–≤–µ—Ä–∫—É —á–µ—Ä–µ–∑ LLM
            text = (doc.original_text or "")[:8000]
            
            llm = create_legal_llm()
            prompt = f"""–ü—Ä–æ–≤–µ—Ä—å –¥–æ–∫—É–º–µ–Ω—Ç –Ω–∞ —Ç–∏–ø–∏—á–Ω—ã–µ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:

–î–û–ö–£–ú–ï–ù–¢: {doc.filename}
{text}

–ü—Ä–æ–≤–µ—Ä—å:
1. –ü–æ–ª–Ω–æ—Ç–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö —Ä–∞–∑–¥–µ–ª–æ–≤
2. –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–æ–∫
3. –ù–∞–ª–∏—á–∏–µ —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π
4. –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —Ä–∏—Å–∫–∏

–î–∞–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç—á—ë—Ç."""

            response = llm.invoke([
                SystemMessage(content="–¢—ã —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞—É–¥–∏—Ç–æ—Ä. –ü—Ä–æ–≤–µ—Ä—è–µ—à—å –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ."),
                HumanMessage(content=prompt)
            ])
            
            result = response.content if hasattr(response, 'content') else str(response)
            return f"‚úÖ **–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞: {doc.filename}**\n\n{result}"
        
        # –ï—Å–ª–∏ –µ—Å—Ç—å playbooks - –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ö
        # TODO: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å PlaybookChecker
        playbook_names = [p.get("name", "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è") for p in playbooks[:5]]
        return f"üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ Playbooks:\n" + "\n".join([f"- {n}" for n in playbook_names]) + "\n\n‚ö†Ô∏è –î–ª—è –ø–æ–ª–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª Playbook –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ."
        
    except Exception as e:
        logger.error(f"[UniversalTools] validate_with_playbook error: {e}")
        return f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏: {str(e)}"


@tool
def get_user_playbooks() -> str:
    """
    –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö Playbooks (–Ω–∞–±–æ—Ä–æ–≤ –ø—Ä–∞–≤–∏–ª).
    
    –ö–û–ì–î–ê –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨:
    - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç "–∫–∞–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –µ—Å—Ç—å"
    - –ü–µ—Ä–µ–¥ –ø—Ä–æ–≤–µ—Ä–∫–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞
    - –ù—É–∂–µ–Ω —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö playbooks
    
    Returns:
        –°–ø–∏—Å–æ–∫ playbooks —Å –æ–ø–∏—Å–∞–Ω–∏—è–º–∏
    """
    global _db, _user_id
    
    if not _db:
        return "–û—à–∏–±–∫–∞: –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞"
    
    try:
        from app.services.playbook_service import PlaybookService
        
        playbook_service = PlaybookService(_db)
        playbooks = playbook_service.get_playbooks(
            user_id=_user_id or "system",
            include_system=True,
            include_public=True,
            limit=20
        )
        
        if not playbooks:
            return "üìã Playbooks –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.\n\n–°–æ–∑–¥–∞–π—Ç–µ Playbook –≤ —Ä–∞–∑–¥–µ–ª–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤."
        
        result = "üìã **–î–æ—Å—Ç—É–ø–Ω—ã–µ Playbooks:**\n\n"
        for p in playbooks:
            name = p.get("name", "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è")
            desc = p.get("description", "")[:100]
            doc_type = p.get("document_type", "all")
            rules_count = p.get("rules_count", 0)
            
            result += f"**{name}**\n"
            if desc:
                result += f"  {desc}\n"
            result += f"  –¢–∏–ø: {doc_type} | –ü—Ä–∞–≤–∏–ª: {rules_count}\n\n"
        
        logger.info(f"[UniversalTools] get_user_playbooks: {len(playbooks)} –Ω–∞–π–¥–µ–Ω–æ")
        return result
        
    except Exception as e:
        logger.error(f"[UniversalTools] get_user_playbooks error: {e}")
        return f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è playbooks: {str(e)}"


# =============================================================================
# –ë–õ–û–ö 5: –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï (2 –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞)
# =============================================================================

@tool
def calculate(expression: str) -> str:
    """
    –í—ã–ø–æ–ª–Ω–∏—Ç—å —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ —Ä–∞—Å—á—ë—Ç—ã.
    
    –ö–û–ì–î–ê –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨:
    - –†–∞—Å—á—ë—Ç –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤, –ø–µ–Ω–µ–π, –Ω–µ—É—Å—Ç–æ–µ–∫
    - –†–∞—Å—á—ë—Ç —Å—Ä–æ–∫–æ–≤ –∏—Å–∫–æ–≤–æ–π –¥–∞–≤–Ω–æ—Å—Ç–∏
    - –ê—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å —Å—É–º–º–∞–º–∏
    - –í–æ–ø—Ä–æ—Å—ã —Ç–∏–ø–∞ "–ø–æ—Å—á–∏—Ç–∞–π", "—Å–∫–æ–ª—å–∫–æ –±—É–¥–µ—Ç", "–∫–∞–∫–∞—è —Å—É–º–º–∞"
    
    Args:
        expression: –í—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è:
            - –ê—Ä–∏—Ñ–º–µ—Ç–∏–∫–∞: "100000 * 0.1" (10% –æ—Ç 100000)
            - –ü—Ä–æ—Ü–µ–Ω—Ç—ã: "percent(100000, 10)" = 10000
            - –ü–µ–Ω–∏ –ø–æ —Å—Ç–∞–≤–∫–µ –¶–ë: "penalty_cb(100000, 30)" = –ø–µ–Ω–∏ –∑–∞ 30 –¥–Ω–µ–π
            - –î–Ω–∏ –º–µ–∂–¥—É –¥–∞—Ç–∞–º–∏: "days_between(01.01.2024, 31.01.2024)"
    
    Returns:
        –†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—Å—á—ë—Ç–∞ —Å –ø–æ—è—Å–Ω–µ–Ω–∏–µ–º
    """
    try:
        result_text = ""
        
        # –ü—Ä–æ—Å—Ç–∞—è –∞—Ä–∏—Ñ–º–µ—Ç–∏–∫–∞
        if re.match(r'^[\d\s\+\-\*\/\.\(\)]+$', expression.replace(',', '.')):
            expr = expression.replace(',', '.').replace(' ', '')
            result = eval(expr)
            result_text = f"üßÆ **–†–µ–∑—É–ª—å—Ç–∞—Ç:** {result:,.2f}".replace(',', ' ')
        
        # –†–∞—Å—á—ë—Ç –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤: percent(—Å—É–º–º–∞, –ø—Ä–æ—Ü–µ–Ω—Ç)
        elif expression.startswith("percent("):
            match = re.match(r'percent\((\d+(?:\.\d+)?),\s*(\d+(?:\.\d+)?)\)', expression)
            if match:
                amount = float(match.group(1))
                percent = float(match.group(2))
                result = amount * percent / 100
                result_text = f"üßÆ **{percent}% –æ—Ç {amount:,.0f}** = {result:,.2f}".replace(',', ' ')
        
        # –ü–µ–Ω–∏ –ø–æ —Å—Ç–∞–≤–∫–µ –¶–ë: penalty_cb(—Å—É–º–º–∞, –¥–Ω–∏)
        elif expression.startswith("penalty_cb("):
            match = re.match(r'penalty_cb\((\d+(?:\.\d+)?),\s*(\d+)\)', expression)
            if match:
                amount = float(match.group(1))
                days = int(match.group(2))
                # –ü—Ä–∏–º–µ—Ä–Ω–∞—è —Å—Ç–∞–≤–∫–∞ –¶–ë (16% –≥–æ–¥–æ–≤—ã—Ö)
                cb_rate = 16.0
                daily_rate = cb_rate / 365 / 100
                penalty = amount * daily_rate * days
                result_text = f"""üßÆ **–†–∞—Å—á—ë—Ç –ø–µ–Ω–∏ –ø–æ —Å—Ç–∞–≤–∫–µ –¶–ë:**
- –°—É–º–º–∞ –¥–æ–ª–≥–∞: {amount:,.0f} —Ä—É–±.
- –ü–µ—Ä–∏–æ–¥: {days} –¥–Ω–µ–π
- –°—Ç–∞–≤–∫–∞ –¶–ë: {cb_rate}% –≥–æ–¥–æ–≤—ã—Ö
- –î–Ω–µ–≤–Ω–∞—è —Å—Ç–∞–≤–∫–∞: {daily_rate*100:.4f}%
- **–ü–µ–Ω–∏: {penalty:,.2f} —Ä—É–±.**""".replace(',', ' ')
        
        # –î–Ω–∏ –º–µ–∂–¥—É –¥–∞—Ç–∞–º–∏: days_between(–¥–∞—Ç–∞1, –¥–∞—Ç–∞2)
        elif expression.startswith("days_between("):
            match = re.match(r'days_between\((\d{2}\.\d{2}\.\d{4}),\s*(\d{2}\.\d{2}\.\d{4})\)', expression)
            if match:
                date1 = datetime.strptime(match.group(1), "%d.%m.%Y")
                date2 = datetime.strptime(match.group(2), "%d.%m.%Y")
                days = abs((date2 - date1).days)
                result_text = f"üßÆ **–î–Ω–µ–π –º–µ–∂–¥—É {match.group(1)} –∏ {match.group(2)}:** {days}"
        
        if not result_text:
            result_text = f"""üßÆ **–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä**

–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –≤—ã—Ä–∞–∂–µ–Ω–∏–µ: `{expression}`

**–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:**
- –ê—Ä–∏—Ñ–º–µ—Ç–∏–∫–∞: `100000 * 0.1`
- –ü—Ä–æ—Ü–µ–Ω—Ç—ã: `percent(100000, 10)` = 10% –æ—Ç 100000
- –ü–µ–Ω–∏ –ø–æ —Å—Ç–∞–≤–∫–µ –¶–ë: `penalty_cb(100000, 30)` = –ø–µ–Ω–∏ –∑–∞ 30 –¥–Ω–µ–π
- –î–Ω–∏ –º–µ–∂–¥—É –¥–∞—Ç–∞–º–∏: `days_between(01.01.2024, 31.01.2024)`"""
        
        logger.info(f"[UniversalTools] calculate: {expression[:50]}")
        return result_text
        
    except Exception as e:
        logger.error(f"[UniversalTools] calculate error: {e}")
        return f"–û—à–∏–±–∫–∞ —Ä–∞—Å—á—ë—Ç–∞: {str(e)}\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç –≤—ã—Ä–∞–∂–µ–Ω–∏—è."


@tool
def get_current_date() -> str:
    """
    –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è.
    
    –ö–û–ì–î–ê –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨:
    - –ù—É–∂–Ω–∞ —Ç–µ–∫—É—â–∞—è –¥–∞—Ç–∞ –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞
    - –†–∞—Å—á—ë—Ç —Å—Ä–æ–∫–æ–≤ –æ—Ç —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã
    - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–æ–∫–æ–≤ –∏—Å–∫–æ–≤–æ–π –¥–∞–≤–Ω–æ—Å—Ç–∏
    
    Returns:
        –¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞ –≤ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö
    """
    now = datetime.now()
    
    result = f"""üìÖ **–¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è:**

- –ü–æ–ª–Ω–∞—è: {now.strftime('%d.%m.%Y %H:%M:%S')}
- –î–∞—Ç–∞: {now.strftime('%d.%m.%Y')}
- –î–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤: ¬´{now.strftime('%d')}¬ª {_month_name(now.month)} {now.strftime('%Y')} –≥.
- ISO —Ñ–æ—Ä–º–∞—Ç: {now.strftime('%Y-%m-%d')}
- –î–µ–Ω—å –Ω–µ–¥–µ–ª–∏: {_weekday_name(now.weekday())}
"""
    
    logger.info("[UniversalTools] get_current_date called")
    return result


def _month_name(month: int) -> str:
    """–ù–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—è—Ü–∞ –≤ —Ä–æ–¥–∏—Ç–µ–ª—å–Ω–æ–º –ø–∞–¥–µ–∂–µ"""
    months = {
        1: "—è–Ω–≤–∞—Ä—è", 2: "—Ñ–µ–≤—Ä–∞–ª—è", 3: "–º–∞—Ä—Ç–∞", 4: "–∞–ø—Ä–µ–ª—è",
        5: "–º–∞—è", 6: "–∏—é–Ω—è", 7: "–∏—é–ª—è", 8: "–∞–≤–≥—É—Å—Ç–∞",
        9: "—Å–µ–Ω—Ç—è–±—Ä—è", 10: "–æ–∫—Ç—è–±—Ä—è", 11: "–Ω–æ—è–±—Ä—è", 12: "–¥–µ–∫–∞–±—Ä—è"
    }
    return months.get(month, "")


def _weekday_name(weekday: int) -> str:
    """–ù–∞–∑–≤–∞–Ω–∏–µ –¥–Ω—è –Ω–µ–¥–µ–ª–∏"""
    days = ["–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫", "–í—Ç–æ—Ä–Ω–∏–∫", "–°—Ä–µ–¥–∞", "–ß–µ—Ç–≤–µ—Ä–≥", "–ü—è—Ç–Ω–∏—Ü–∞", "–°—É–±–±–æ—Ç–∞", "–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ"]
    return days[weekday] if 0 <= weekday < 7 else ""


# =============================================================================
# –§–ê–ë–†–ò–ö–ê –ò–ù–°–¢–†–£–ú–ï–ù–¢–û–í
# =============================================================================

def get_universal_tools(
    db: Session,
    rag_service,
    case_id: str,
    user_id: Optional[str] = None,
    legal_research: bool = False,
    web_search: bool = False
) -> List:
    """
    –ü–æ–ª—É—á–∏—Ç—å –Ω–∞–±–æ—Ä –∏–∑ 12 —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤.
    
    Args:
        db: SQLAlchemy —Å–µ—Å—Å–∏—è
        rag_service: RAG —Å–µ—Ä–≤–∏—Å
        case_id: ID –¥–µ–ª–∞
        user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        legal_research: –í–∫–ª—é—á–∏—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –ì–ê–†–ê–ù–¢
        web_search: –í–∫–ª—é—á–∏—Ç—å –≤–µ–±-–ø–æ–∏—Å–∫ (–ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω)
    
    Returns:
        –°–ø–∏—Å–æ–∫ –∏–∑ 12 –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
    """
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
    initialize_universal_tools(db, rag_service, case_id, user_id)
    
    # –ë–∞–∑–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (–≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω—ã)
    tools = [
        # –ë–ª–æ–∫ 1: –î–æ–∫—É–º–µ–Ω—Ç—ã
        get_document,
        search_in_documents,
        extract_structured_data,
        compare_documents,
        
        # –ë–ª–æ–∫ 3: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è
        generate_document,
        list_templates,
        
        # –ë–ª–æ–∫ 4: Playbook
        validate_with_playbook,
        get_user_playbooks,
        
        # –ë–ª–æ–∫ 5: –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ
        calculate,
        get_current_date,
    ]
    
    # –ë–ª–æ–∫ 2: –ó–∞–∫–æ–Ω—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    if legal_research:
        tools.extend([
            search_garant,
            get_law_article,
        ])
        logger.info("[UniversalTools] GARANT tools enabled")
    
    # –í–µ–±-–ø–æ–∏—Å–∫ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    if web_search:
        try:
            from app.services.langchain_agents.web_research_tool import web_research_tool
            tools.append(web_research_tool)
            logger.info("[UniversalTools] Web search tool enabled")
        except ImportError:
            logger.warning("[UniversalTools] Web search tool not available")
    
    logger.info(f"[UniversalTools] Initialized {len(tools)} tools for case {case_id}")
    return tools

