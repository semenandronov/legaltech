"""
Thinking Service - –°–µ—Ä–≤–∏—Å –ø–æ—à–∞–≥–æ–≤–æ–≥–æ –º—ã—à–ª–µ–Ω–∏—è –ò–ò

–†–µ–∞–ª–∏–∑—É–µ—Ç Chain-of-Thought reasoning –¥–ª—è —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞—á.
–ö–∞–∂–¥—ã–π –æ—Ç–≤–µ—Ç –ø—Ä–æ—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ —ç—Ç–∞–ø—ã –∞–Ω–∞–ª–∏–∑–∞ –ø–µ—Ä–µ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π.

–ü—Ä–∏ deep_think=True –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è GigaChat Pro —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º –Ω–∞–±–æ—Ä–æ–º —Ñ–∞–∑ –∞–Ω–∞–ª–∏–∑–∞.
"""
from typing import AsyncGenerator, Dict, Any, List, Optional
from dataclasses import dataclass
from enum import Enum
import logging
import json
import time

from langchain_core.messages import HumanMessage, SystemMessage, AIMessage
from app.services.llm_factory import create_legal_llm
from app.config import config

logger = logging.getLogger(__name__)


class ThinkingPhase(Enum):
    """–§–∞–∑—ã –º—ã—à–ª–µ–Ω–∏—è –ò–ò"""
    UNDERSTANDING = "understanding"        # –ü–æ–Ω–∏–º–∞–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞
    CONTEXT_ANALYSIS = "context"           # –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    REASONING = "reasoning"                # –†–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ
    COUNTERARGUMENTS = "counterarguments"  # –ö–æ–Ω—Ç—Ä–∞—Ä–≥—É–º–µ–Ω—Ç—ã (—Ç–æ–ª—å–∫–æ deep_think)
    LEGAL_ANALYSIS = "legal_analysis"      # –ü—Ä–∞–≤–æ–≤–æ–π –∞–Ω–∞–ª–∏–∑ (—Ç–æ–ª—å–∫–æ deep_think)
    PRECEDENTS = "precedents"              # –ê–Ω–∞–ª–∏–∑ –ø—Ä–µ—Ü–µ–¥–µ–Ω—Ç–æ–≤ (—Ç–æ–ª—å–∫–æ deep_think)
    SYNTHESIS = "synthesis"                # –°–∏–Ω—Ç–µ–∑ –æ—Ç–≤–µ—Ç–∞


# –ë–∞–∑–æ–≤—ã–µ —Ñ–∞–∑—ã (–æ–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º)
BASIC_PHASES = [
    ThinkingPhase.UNDERSTANDING,
    ThinkingPhase.CONTEXT_ANALYSIS,
    ThinkingPhase.REASONING,
    ThinkingPhase.SYNTHESIS
]

# –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ–∞–∑—ã (deep_think —Ä–µ–∂–∏–º)
DEEP_THINK_PHASES = [
    ThinkingPhase.UNDERSTANDING,
    ThinkingPhase.CONTEXT_ANALYSIS,
    ThinkingPhase.REASONING,
    ThinkingPhase.COUNTERARGUMENTS,
    ThinkingPhase.LEGAL_ANALYSIS,
    ThinkingPhase.PRECEDENTS,
    ThinkingPhase.SYNTHESIS
]


@dataclass
class ThinkingStep:
    """–®–∞–≥ –º—ã—à–ª–µ–Ω–∏—è"""
    phase: ThinkingPhase
    step_number: int
    total_steps: int
    content: str
    duration_ms: Optional[int] = None
    
    def to_dict(self) -> Dict[str, Any]:
        return {
            "phase": self.phase.value,
            "step": self.step_number,
            "totalSteps": self.total_steps,
            "content": self.content,
            "duration_ms": self.duration_ms
        }


class ThinkingService:
    """
    –°–µ—Ä–≤–∏—Å –ø–æ—à–∞–≥–æ–≤–æ–≥–æ –º—ã—à–ª–µ–Ω–∏—è –¥–ª—è —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–≥–æ –ò–ò.
    
    –†–µ–∞–ª–∏–∑—É–µ—Ç –ø–æ–¥—Ö–æ–¥, –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π Harvey AI –∏ CoCounsel:
    1. –ü–æ–Ω–∏–º–∞–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞ - —á—Ç–æ –∏–º–µ–Ω–Ω–æ —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    2. –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ - –∫–∞–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã/—Ñ–∞–∫—Ç—ã —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã
    3. –†–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ - –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –≤—ã–≤–æ–¥—ã
    4. [deep_think] –ö–æ–Ω—Ç—Ä–∞—Ä–≥—É–º–µ–Ω—Ç—ã - –≤–æ–∑–º–æ–∂–Ω—ã–µ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è
    5. [deep_think] –ü—Ä–∞–≤–æ–≤–æ–π –∞–Ω–∞–ª–∏–∑ - –ø—Ä–∏–º–µ–Ω–∏–º—ã–µ –Ω–æ—Ä–º—ã
    6. [deep_think] –ü—Ä–µ—Ü–µ–¥–µ–Ω—Ç—ã - —Å—É–¥–µ–±–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞
    7. –°–∏–Ω—Ç–µ–∑ - —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞
    
    –ü—Ä–∏ deep_think=True –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è GigaChat Pro –¥–ª—è –±–æ–ª–µ–µ –≥–ª—É–±–æ–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.
    """
    
    # –ë–∞–∑–æ–≤—ã–µ –ø—Ä–æ–º–ø—Ç—ã (–æ–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º)
    PHASE_PROMPTS = {
        ThinkingPhase.UNDERSTANDING: """–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –æ–ø—Ä–µ–¥–µ–ª–∏:
1. –ß—Ç–æ –∏–º–µ–Ω–Ω–æ —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å?
2. –ö–∞–∫–æ–π —Ç–∏–ø –≤–æ–ø—Ä–æ—Å–∞ (—Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π, –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π, —Å—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω—ã–π)?
3. –ö–∞–∫–∏–µ –∫–ª—é—á–µ–≤—ã–µ –∞—Å–ø–µ–∫—Ç—ã –Ω—É–∂–Ω–æ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å?

–í–æ–ø—Ä–æ—Å: {question}

–û—Ç–≤–µ—Ç—å –∫—Ä–∞—Ç–∫–æ (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è), –Ω–∞—á–Ω–∏ —Å "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ...".""",

        ThinkingPhase.CONTEXT_ANALYSIS: """–ù–∞ –æ—Å–Ω–æ–≤–µ –≤–æ–ø—Ä–æ—Å–∞ –∏ –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –æ–ø—Ä–µ–¥–µ–ª–∏:
1. –ö–∞–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã/–∏—Å—Ç–æ—á–Ω–∏–∫–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã?
2. –ö–∞–∫–∏–µ —Ñ–∞–∫—Ç—ã –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤–∞–∂–Ω—ã –¥–ª—è –æ—Ç–≤–µ—Ç–∞?
3. –ï—Å—Ç—å –ª–∏ –ø—Ä–æ–±–µ–ª—ã –≤ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏?

–í–æ–ø—Ä–æ—Å: {question}
–ö–æ–Ω—Ç–µ–∫—Å—Ç: {context}

–û—Ç–≤–µ—Ç—å –∫—Ä–∞—Ç–∫–æ (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è), –Ω–∞—á–Ω–∏ —Å "–î–ª—è –æ—Ç–≤–µ—Ç–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã...".""",

        ThinkingPhase.REASONING: """–ü—Ä–æ–≤–µ–¥–∏ –ª–æ–≥–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑:
1. –ö–∞–∫–∏–µ –≤—ã–≤–æ–¥—ã –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –∏–∑ —Ñ–∞–∫—Ç–æ–≤?
2. –ï—Å—Ç—å –ª–∏ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è –∏–ª–∏ –Ω–µ—è—Å–Ω–æ—Å—Ç–∏?
3. –ö–∞–∫–∏–µ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ –Ω–æ—Ä–º—ã –ø—Ä–∏–º–µ–Ω–∏–º—ã?

–í–æ–ø—Ä–æ—Å: {question}
–ö–æ–Ω—Ç–µ–∫—Å—Ç: {context}
–ü–æ–Ω–∏–º–∞–Ω–∏–µ: {understanding}

–û—Ç–≤–µ—Ç—å –∫—Ä–∞—Ç–∫–æ (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è), –Ω–∞—á–Ω–∏ —Å "–ê–Ω–∞–ª–∏–∑–∏—Ä—É—è —Ñ–∞–∫—Ç—ã...".""",

        ThinkingPhase.SYNTHESIS: """–°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –ø–ª–∞–Ω –æ—Ç–≤–µ—Ç–∞:
1. –ö–∞–∫–∏–µ –∫–ª—é—á–µ–≤—ã–µ –ø—É–Ω–∫—Ç—ã –≤–∫–ª—é—á–∏—Ç—å?
2. –í –∫–∞–∫–æ–º –ø–æ—Ä—è–¥–∫–µ –∏–∑–ª–æ–∂–∏—Ç—å?
3. –ö–∞–∫–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –ø—Ä–æ—Ü–∏—Ç–∏—Ä–æ–≤–∞—Ç—å?

–í–æ–ø—Ä–æ—Å: {question}
–†–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ: {reasoning}

–û—Ç–≤–µ—Ç—å –∫—Ä–∞—Ç–∫–æ (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è), –Ω–∞—á–Ω–∏ —Å "–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –≤–∫–ª—é—á–∞—Ç—å..."."""
    }
    
    # –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã (deep_think —Ä–µ–∂–∏–º —Å GigaChat Pro)
    DEEP_THINK_PROMPTS = {
        ThinkingPhase.UNDERSTANDING: """–ü—Ä–æ–≤–µ–¥–∏ –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –≤–æ–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:

1. –ß—Ç–æ –∏–º–µ–Ω–Ω–æ —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å? –ö–∞–∫–æ–≤–∞ –æ—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–ª—å –≤–æ–ø—Ä–æ—Å–∞?
2. –ö–∞–∫–æ–π —Ç–∏–ø –≤–æ–ø—Ä–æ—Å–∞: —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π, –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π, —Å—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω—ã–π, –ø—Ä–æ–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π?
3. –ö–∞–∫–∏–µ –∫–ª—é—á–µ–≤—ã–µ –∞—Å–ø–µ–∫—Ç—ã –∏ –ø–æ–¥–≤–æ–ø—Ä–æ—Å—ã –Ω—É–∂–Ω–æ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å?
4. –ö–∞–∫–∏–µ –Ω–µ—è–≤–Ω—ã–µ –ø—Ä–µ–¥–ø–æ—Å—ã–ª–∫–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤–æ–ø—Ä–æ—Å?
5. –ö–∞–∫–æ–π —É—Ä–æ–≤–µ–Ω—å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ –æ–∂–∏–¥–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å?

–í–æ–ø—Ä–æ—Å: {question}

–û—Ç–≤–µ—Ç—å —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ (4-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π), –Ω–∞—á–Ω–∏ —Å "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–¥–∞–µ—Ç –≤–æ–ø—Ä–æ—Å –æ...".""",

        ThinkingPhase.CONTEXT_ANALYSIS: """–ü—Ä–æ–≤–µ–¥–∏ –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:

1. –ö–∞–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –Ω–∞–∏–±–æ–ª–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã –¥–ª—è –æ—Ç–≤–µ—Ç–∞?
2. –ö–∞–∫–∏–µ –∫–ª—é—á–µ–≤—ã–µ —Ñ–∞–∫—Ç—ã, –¥–∞—Ç—ã, —Å—É–º–º—ã, –∏–º–µ–Ω–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç?
3. –ö–∞–∫–∏–µ —Ñ–∞–∫—Ç—ã –Ω–∞–ø—Ä—è–º—É—é –æ—Ç–Ω–æ—Å—è—Ç—Å—è –∫ –≤–æ–ø—Ä–æ—Å—É?
4. –ï—Å—Ç—å –ª–∏ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è –º–µ–∂–¥—É —Ä–∞–∑–Ω—ã–º–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏?
5. –ö–∞–∫–∏–µ –ø—Ä–æ–±–µ–ª—ã –≤ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç?
6. –ö–∞–∫–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –ø–æ–ª–µ–∑–Ω—ã?

–í–æ–ø—Ä–æ—Å: {question}
–ö–æ–Ω—Ç–µ–∫—Å—Ç: {context}

–û—Ç–≤–µ—Ç—å —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ (5-6 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π), –Ω–∞—á–Ω–∏ —Å "–ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç...".""",

        ThinkingPhase.REASONING: """–ü—Ä–æ–≤–µ–¥–∏ –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—ã–π –ª–æ–≥–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑:

1. –ö–∞–∫–∏–µ –ø—Ä—è–º—ã–µ –≤—ã–≤–æ–¥—ã —Å–ª–µ–¥—É—é—Ç –∏–∑ —Ñ–∞–∫—Ç–æ–≤?
2. –ö–∞–∫–∏–µ –∫–æ—Å–≤–µ–Ω–Ω—ã–µ –≤—ã–≤–æ–¥—ã –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?
3. –ï—Å—Ç—å –ª–∏ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è –∏–ª–∏ –Ω–µ—è—Å–Ω–æ—Å—Ç–∏?
4. –ö–∞–∫–∏–µ –ø—Ä–∏—á–∏–Ω–Ω–æ-—Å–ª–µ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–≤—è–∑–∏ –ø—Ä–æ—Å–ª–µ–∂–∏–≤–∞—é—Ç—Å—è?
5. –ö–∞–∫–∏–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏ –≤–æ–∑–º–æ–∂–Ω—ã?
6. –ö–∞–∫–æ–≤–∞ —Å—Ç–µ–ø–µ–Ω—å –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ—Å—Ç–∏ –∫–∞–∂–¥–æ–≥–æ –≤—ã–≤–æ–¥–∞?

–í–æ–ø—Ä–æ—Å: {question}
–ö–æ–Ω—Ç–µ–∫—Å—Ç: {context}
–ü–æ–Ω–∏–º–∞–Ω–∏–µ: {understanding}

–û—Ç–≤–µ—Ç—å —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ (5-6 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π), –Ω–∞—á–Ω–∏ —Å "–õ–æ–≥–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –≤—ã—è–≤–ª—è–µ—Ç...".""",

        ThinkingPhase.COUNTERARGUMENTS: """–†–∞—Å—Å–º–æ—Ç—Ä–∏ –≤–æ–∑–º–æ–∂–Ω—ã–µ –∫–æ–Ω—Ç—Ä–∞—Ä–≥—É–º–µ–Ω—Ç—ã –∏ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è:

1. –ö–∞–∫–∏–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã –º–æ–∂–µ—Ç –≤—ã–¥–≤–∏–Ω—É—Ç—å –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞?
2. –ö–∞–∫–∏–µ —Å–ª–∞–±—ã–µ –º–µ—Å—Ç–∞ –µ—Å—Ç—å –≤ –Ω–∞—à–µ–π –ø–æ–∑–∏—Ü–∏–∏?
3. –ö–∞–∫–∏–µ —Ñ–∞–∫—Ç—ã –º–æ–≥—É—Ç –±—ã—Ç—å –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞–Ω—ã –∏–Ω–∞—á–µ?
4. –ö–∞–∫–∏–µ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ —Ä–∏—Å–∫–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç?
5. –ö–∞–∫ –º–æ–∂–Ω–æ —É–∫—Ä–µ–ø–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é –∏ –ø–∞—Ä–∏—Ä–æ–≤–∞—Ç—å –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è?

–í–æ–ø—Ä–æ—Å: {question}
–†–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ: {reasoning}

–û—Ç–≤–µ—Ç—å —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ (4-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π), –Ω–∞—á–Ω–∏ —Å "–í–æ–∑–º–æ–∂–Ω—ã–µ –∫–æ–Ω—Ç—Ä–∞—Ä–≥—É–º–µ–Ω—Ç—ã –≤–∫–ª—é—á–∞—é—Ç...".""",

        ThinkingPhase.LEGAL_ANALYSIS: """–ü—Ä–æ–≤–µ–¥–∏ –ø—Ä–∞–≤–æ–≤–æ–π –∞–Ω–∞–ª–∏–∑ —Å–∏—Ç—É–∞—Ü–∏–∏:

1. –ö–∞–∫–∏–µ –Ω–æ—Ä–º—ã –ø—Ä–∞–≤–∞ (–∑–∞–∫–æ–Ω—ã, –∫–æ–¥–µ–∫—Å—ã, –ø–æ–¥–∑–∞–∫–æ–Ω–Ω—ã–µ –∞–∫—Ç—ã) –ø—Ä–∏–º–µ–Ω–∏–º—ã?
2. –ö–∞–∫–∏–µ —Å—Ç–∞—Ç—å–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ —Ä–µ–≥—É–ª–∏—Ä—É—é—Ç –¥–∞–Ω–Ω—ã–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è?
3. –ï—Å—Ç—å –ª–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –Ω–æ—Ä–º—ã, –∏–º–µ—é—â–∏–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞–¥ –æ–±—â–∏–º–∏?
4. –ö–∞–∫–∏–µ –ø—Ä–∞–≤–æ–≤—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –≤—ã—Å—à–∏—Ö —Å—É–¥–æ–≤ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –ø–æ –¥–∞–Ω–Ω–æ–º—É –≤–æ–ø—Ä–æ—Å—É?
5. –ö–∞–∫–∏–µ —Å—Ä–æ–∫–∏ –∏—Å–∫–æ–≤–æ–π –¥–∞–≤–Ω–æ—Å—Ç–∏ –∏ –ø—Ä–æ—Ü–µ—Å—Å—É–∞–ª—å–Ω—ã–µ —Å—Ä–æ–∫–∏ –ø—Ä–∏–º–µ–Ω–∏–º—ã?
6. –ö–∞–∫–∏–µ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏?

–í–æ–ø—Ä–æ—Å: {question}
–ö–æ–Ω—Ç–µ–∫—Å—Ç: {context}
–†–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ: {reasoning}

–û—Ç–≤–µ—Ç—å —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ (5-6 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π), –Ω–∞—á–Ω–∏ —Å "–° –ø—Ä–∞–≤–æ–≤–æ–π —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è...".""",

        ThinkingPhase.PRECEDENTS: """–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å—É–¥–µ–±–Ω—É—é –ø—Ä–∞–∫—Ç–∏–∫—É –∏ –ø—Ä–µ—Ü–µ–¥–µ–Ω—Ç—ã:

1. –ö–∞–∫–∏–µ —Ä–µ—à–µ–Ω–∏—è —Å—É–¥–æ–≤ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã –¥–ª—è –¥–∞–Ω–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏?
2. –ö–∞–∫–æ–≤–∞ –ø–æ–∑–∏—Ü–∏—è –í–µ—Ä—Ö–æ–≤–Ω–æ–≥–æ –°—É–¥–∞ –†–§ –ø–æ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–º –¥–µ–ª–∞–º?
3. –ï—Å—Ç—å –ª–∏ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–≤–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ –≤ —Ä–∞–∑–Ω—ã—Ö —Å—É–¥–∞—Ö?
4. –ö–∞–∫–∏–µ —Ç–µ–Ω–¥–µ–Ω—Ü–∏–∏ –ø—Ä–æ—Å–ª–µ–∂–∏–≤–∞—é—Ç—Å—è –≤ —Å—É–¥–µ–±–Ω–æ–π –ø—Ä–∞–∫—Ç–∏–∫–µ?
5. –ö–∞–∫–∏–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã —Å—É–¥—ã –ø—Ä–∏–Ω–∏–º–∞—é—Ç, –∞ –∫–∞–∫–∏–µ –æ—Ç–∫–ª–æ–Ω—è—é—Ç?

–í–æ–ø—Ä–æ—Å: {question}
–ü—Ä–∞–≤–æ–≤–æ–π –∞–Ω–∞–ª–∏–∑: {legal_analysis}

–û—Ç–≤–µ—Ç—å —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ (4-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π), –Ω–∞—á–Ω–∏ —Å "–°—É–¥–µ–±–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç...".""",

        ThinkingPhase.SYNTHESIS: """–°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –ø–ª–∞–Ω –æ—Ç–≤–µ—Ç–∞:

1. –ö–∞–∫–∏–µ –∫–ª—é—á–µ–≤—ã–µ –≤—ã–≤–æ–¥—ã –Ω—É–∂–Ω–æ –¥–æ–Ω–µ—Å—Ç–∏ –¥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?
2. –í –∫–∞–∫–æ–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏–∑–ª–æ–∂–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —è—Å–Ω–æ—Å—Ç–∏?
3. –ö–∞–∫–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏ –Ω–æ—Ä–º—ã –ø—Ä–∞–≤–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ—Ü–∏—Ç–∏—Ä–æ–≤–∞—Ç—å?
4. –ö–∞–∫–∏–µ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–∞—Ç—å?
5. –ù–∞ –∫–∞–∫–∏–µ —Ä–∏—Å–∫–∏ –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ?
6. –ö–∞–∫–∏–µ –¥–∞–ª—å–Ω–µ–π—à–∏–µ —à–∞–≥–∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å?

–í–æ–ø—Ä–æ—Å: {question}
–†–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ: {reasoning}
–ö–æ–Ω—Ç—Ä–∞—Ä–≥—É–º–µ–Ω—Ç—ã: {counterarguments}
–ü—Ä–∞–≤–æ–≤–æ–π –∞–Ω–∞–ª–∏–∑: {legal_analysis}
–ü—Ä–µ—Ü–µ–¥–µ–Ω—Ç—ã: {precedents}

–û—Ç–≤–µ—Ç—å —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ (5-6 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π), –Ω–∞—á–Ω–∏ —Å "–ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω..."."""
    }
    
    def __init__(self, temperature: float = 0.1, deep_think: bool = False):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–∞ –º—ã—à–ª–µ–Ω–∏—è
        
        Args:
            temperature: –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–ª—è LLM (–Ω–∏–∑–∫–∞—è –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏)
            deep_think: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ —Å GigaChat Pro
        """
        self.deep_think = deep_think
        self.temperature = temperature
        
        # –í—ã–±–∏—Ä–∞–µ–º –º–æ–¥–µ–ª—å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
        if deep_think:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º GigaChat Pro –¥–ª—è –≥–ª—É–±–æ–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
            model = config.GIGACHAT_PRO_MODEL or "GigaChat-Pro"
            self.phases = DEEP_THINK_PHASES
            self.prompts = self.DEEP_THINK_PROMPTS
            logger.info(f"[ThinkingService] Initialized in DEEP THINK mode with model: {model}")
        else:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –º–æ–¥–µ–ª—å
            model = None  # –ë—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ –º–æ–¥–µ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            self.phases = BASIC_PHASES
            self.prompts = self.PHASE_PROMPTS
            logger.info("[ThinkingService] Initialized in standard mode")
        
        self.llm = create_legal_llm(model=model, temperature=temperature)
        self.total_steps = len(self.phases)
        
    async def think(
        self,
        question: str,
        context: str = "",
        stream_steps: bool = True
    ) -> AsyncGenerator[ThinkingStep, None]:
        """
        –í—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ—à–∞–≥–æ–≤–æ–µ –º—ã—à–ª–µ–Ω–∏–µ
        
        Args:
            question: –í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (RAG)
            stream_steps: –°—Ç—Ä–∏–º–∏—Ç—å —à–∞–≥–∏ –ø–æ –º–µ—Ä–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
            
        Yields:
            ThinkingStep –¥–ª—è –∫–∞–∂–¥–æ–π —Ñ–∞–∑—ã
        """
        mode = "DEEP THINK" if self.deep_think else "standard"
        logger.info(f"[ThinkingService] Starting {mode} thinking process for: {question[:100]}...")
        
        results = {}
        step_number = 0
        
        # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ª–∏–º–∏—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è deep_think
        context_limit = 5000 if self.deep_think else 2000
        
        for phase in self.phases:
            step_number += 1
            start_time = time.time()
            
            try:
                # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ–º–ø—Ç –¥–ª—è —Ñ–∞–∑—ã
                prompt_template = self.prompts.get(phase)
                if not prompt_template:
                    logger.warning(f"[ThinkingService] No prompt for phase {phase.value}, skipping")
                    continue
                
                # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç —Å –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
                prompt = prompt_template.format(
                    question=question,
                    context=context[:context_limit] if context else "–ö–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω",
                    understanding=results.get(ThinkingPhase.UNDERSTANDING, ""),
                    reasoning=results.get(ThinkingPhase.REASONING, ""),
                    counterarguments=results.get(ThinkingPhase.COUNTERARGUMENTS, ""),
                    legal_analysis=results.get(ThinkingPhase.LEGAL_ANALYSIS, ""),
                    precedents=results.get(ThinkingPhase.PRECEDENTS, "")
                )
                
                # –í—ã–∑—ã–≤–∞–µ–º LLM
                response = await self._call_llm(prompt)
                results[phase] = response
                
                duration_ms = int((time.time() - start_time) * 1000)
                
                step = ThinkingStep(
                    phase=phase,
                    step_number=step_number,
                    total_steps=self.total_steps,
                    content=response,
                    duration_ms=duration_ms
                )
                
                logger.info(f"[ThinkingService] Phase {phase.value} completed in {duration_ms}ms ({mode} mode)")
                
                if stream_steps:
                    yield step
                    
            except Exception as e:
                logger.error(f"[ThinkingService] Error in phase {phase.value}: {e}")
                # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å fallback
                step = ThinkingStep(
                    phase=phase,
                    step_number=step_number,
                    total_steps=self.total_steps,
                    content=f"–ê–Ω–∞–ª–∏–∑ {phase.value}...",
                    duration_ms=0
                )
                if stream_steps:
                    yield step
    
    async def _call_llm(self, prompt: str) -> str:
        """–í—ã–∑–æ–≤ LLM —Å –ø—Ä–æ–º–ø—Ç–æ–º"""
        try:
            if self.deep_think:
                system_content = """–¢—ã - –æ–ø—ã—Ç–Ω—ã–π —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, –≤—ã–ø–æ–ª–Ω—è—é—â–∏–π –≥–ª—É–±–æ–∫–∏–π –ø–æ—à–∞–≥–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑.
–¢—ã –∏—Å–ø–æ–ª—å–∑—É–µ—à—å –º–æ–¥–µ–ª—å GigaChat Pro –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∏ –≤—Å–µ—Å—Ç–æ—Ä–æ–Ω–Ω–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.
–û—Ç–≤–µ—á–∞–π —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ –∏ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω–æ. –ò—Å–ø–æ–ª—å–∑—É–π —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫.
–ü—Ä–∏–≤–æ–¥–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –Ω–æ—Ä–º—ã –ø—Ä–∞–≤–∞, —Å—Ç–∞—Ç—å–∏ –∏ —Å—É–¥–µ–±–Ω—É—é –ø—Ä–∞–∫—Ç–∏–∫—É –≥–¥–µ –ø—Ä–∏–º–µ–Ω–∏–º–æ."""
            else:
                system_content = """–¢—ã - —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, –≤—ã–ø–æ–ª–Ω—è—é—â–∏–π –ø–æ—à–∞–≥–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑.
–û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ —Å—É—â–µ—Å—Ç–≤—É. –ò—Å–ø–æ–ª—å–∑—É–π —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫.
–ù–µ –¥–æ–±–∞–≤–ª—è–π –ª–∏—à–Ω–∏—Ö –ø–æ—è—Å–Ω–µ–Ω–∏–π - —Ç–æ–ª—å–∫–æ —Å—É—Ç—å –∞–Ω–∞–ª–∏–∑–∞."""
            
            system_message = SystemMessage(content=system_content)
            human_message = HumanMessage(content=prompt)
            
            response = self.llm.invoke([system_message, human_message])
            
            if isinstance(response, AIMessage):
                return response.content or ""
            elif hasattr(response, 'content'):
                return response.content or ""
            return str(response)
            
        except Exception as e:
            logger.error(f"[ThinkingService] LLM call failed: {e}")
            return ""
    
    def get_thinking_summary(self, steps: List[ThinkingStep]) -> str:
        """
        –ü–æ–ª—É—á–∏—Ç—å –∫—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ –ø—Ä–æ—Ü–µ—Å—Å–∞ –º—ã—à–ª–µ–Ω–∏—è
        
        Args:
            steps: –°–ø–∏—Å–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —à–∞–≥–æ–≤
            
        Returns:
            –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ–∑—é–º–µ
        """
        summary_parts = []
        for step in steps:
            phase_name = {
                ThinkingPhase.UNDERSTANDING: "üìã –ü–æ–Ω–∏–º–∞–Ω–∏–µ",
                ThinkingPhase.CONTEXT_ANALYSIS: "üîç –ö–æ–Ω—Ç–µ–∫—Å—Ç", 
                ThinkingPhase.REASONING: "üí≠ –†–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ",
                ThinkingPhase.COUNTERARGUMENTS: "‚öñÔ∏è –ö–æ–Ω—Ç—Ä–∞—Ä–≥—É–º–µ–Ω—Ç—ã",
                ThinkingPhase.LEGAL_ANALYSIS: "üìú –ü—Ä–∞–≤–æ–≤–æ–π –∞–Ω–∞–ª–∏–∑",
                ThinkingPhase.PRECEDENTS: "üèõÔ∏è –ü—Ä–µ—Ü–µ–¥–µ–Ω—Ç—ã",
                ThinkingPhase.SYNTHESIS: "‚úÖ –°–∏–Ω—Ç–µ–∑"
            }.get(step.phase, step.phase.value)
            
            summary_parts.append(f"{phase_name}: {step.content}")
        
        return "\n\n".join(summary_parts)


# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —ç–∫–∑–µ–º–ø–ª—è—Ä—ã —Å–µ—Ä–≤–∏—Å–æ–≤ (–∫—ç—à–∏—Ä—É–µ–º –æ–±–∞ —Ä–µ–∂–∏–º–∞)
_thinking_service: Optional[ThinkingService] = None
_deep_thinking_service: Optional[ThinkingService] = None


def get_thinking_service(deep_think: bool = False) -> ThinkingService:
    """
    –ü–æ–ª—É—á–∏—Ç—å —ç–∫–∑–µ–º–ø–ª—è—Ä ThinkingService
    
    Args:
        deep_think: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ —Å GigaChat Pro
        
    Returns:
        ThinkingService –≤ –Ω—É–∂–Ω–æ–º —Ä–µ–∂–∏–º–µ
    """
    global _thinking_service, _deep_thinking_service
    
    if deep_think:
        if _deep_thinking_service is None:
            _deep_thinking_service = ThinkingService(deep_think=True)
        return _deep_thinking_service
    else:
        if _thinking_service is None:
            _thinking_service = ThinkingService(deep_think=False)
        return _thinking_service
